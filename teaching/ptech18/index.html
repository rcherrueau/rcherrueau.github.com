<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-12-14 Fri 16:58 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Operate Resources in Public and Private Clouds Thanks to OpenStack</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Ronan-Alexandre Cherrueau, Adrien Lebre, Didier Iscovery">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="timeline.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Operate Resources in Public and Private Clouds Thanks to OpenStack</h1>
</header><div class="abstract">
<p>
OpenStack has become the de-facto solution to operate compute, network
and storage resources in public and private clouds. In this lab, we
are going to:
</p>
<ul class="org-ul">
<li>Deploy an all-in-one OpenStack with <a href="https://github.com/CanonicalLtd/microstack">Snap microstack</a>.</li>
<li>Operate this OpenStack to manage IaaS resources (e.g., boot VMs,
setup a private Network).</li>
<li>Deploys a Wordpress as a Service.</li>
</ul>

<p>
Find the slides of the lecture <a href="http://enos.irisa.fr/tp-polytech/openstack-slides.pdf">there</a>.
</p>

</div>

<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgeba425c">1. Requirements and Setup</a>
<ul>
<li><a href="#org347d4af">1.1. Resources of the Lab</a></li>
<li><a href="#org38ae789">1.2. Environment</a></li>
<li><a href="#orgcf86307">1.3. Setup OpenStack</a></li>
</ul>
</li>
<li><a href="#sec:play-with-os">2. Play with OpenStack</a>
<ul>
<li><a href="#orgfe184e4">2.1. OpenStack Horizon Dashboard</a></li>
<li><a href="#orgc185365">2.2. Unleash the Operator in You</a></li>
<li><a href="#org3819c75">2.3. In Encryption We Trust</a></li>
<li><a href="#org1e34eb7">2.4. The Art of Provisioning a VM</a>
<ul>
<li><a href="#sec:debian9-ftw">2.4.1. Debian 9 FTW</a></li>
<li><a href="#org8c8ae9f">2.4.2. Cloudinit in Action</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org6d066e8">3. Deploy a Wordpress as a Service</a>
<ul>
<li><a href="#org1899024">3.1. Wordpress MySQL Database&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></a></li>
<li><a href="#orgcebb86f">3.2. Wordpress Application&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></a></li>
</ul>
</li>
<li><a href="#org3077325">4. Appendix</a>
<ul>
<li><a href="#orge177ae5">4.1. Installs MariaDB on Debian 9</a></li>
<li><a href="#org52bc7d9">4.2. Installs Wordpress on Debian 9</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orgeba425c" class="outline-2">
<h2 id="orgeba425c"><span class="section-number-2">1</span> Requirements and Setup</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org347d4af" class="outline-3">
<h3 id="org347d4af"><span class="section-number-3">1.1</span> Resources of the Lab</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Get the resources of the lab at <a href="https://rcherrueau.github.io/teaching/ptech18/tp.tar.gz">https://rcherrueau.github.io/teaching/ptech18/tp.tar.gz</a>.
</p>

<div class="org-src-container">
<pre class="src src-bash">curl -O https://rcherrueau.github.io/teaching/ptech18/tp.tar.gz
tar xf tp.tar.gz
<span style="color: #DCDCCC; font-weight: bold;">cd</span> ptech18
</pre>
</div>

<p>
The archive contains:
</p>
<dl class="org-dl">
<dt>index.txt</dt><dd>The current subject in text format.</dd>
<dt>setup.sh</dt><dd>Script that sets up the lab.</dd>
<dt>teardown.sh</dt><dd>Script that uninstalls the lab.</dd>
<dt>rsc</dt><dd>Resource directory with bash scripts useful for the lab.</dd>
</dl>
</div>
</div>

<div id="outline-container-org38ae789" class="outline-3">
<h3 id="org38ae789"><span class="section-number-3">1.2</span> Environment</h3>
<div class="outline-text-3" id="text-1-2">
<p>
To follow the lab you&rsquo;ll need a Linux (prefer Ubuntu 18.04) with 6 Go
of RAM and a few Go of disk.
</p>

<p>
The lab makes use of <a href="https://github.com/CanonicalLtd/microstack">Snap microstack</a>: OpenStack in a Snap that you can
run locally on a single machine. Snap is the Canonical&rsquo;s App delivery
mechanism. It enables developers to bundle all dependencies into a
single app package. And so does Snap microstack for an all-in-one
OpenStack on your machine.
</p>

<p>
An all-in-one OpenStack means that your machine will contain both
services to <i>operate</i> and <i>host</i> virtualized resources. For instance,
the <code>nova-conductor</code> to operate the boot of a VM, and <code>nova-compute</code>
to host the VM. Which is a good setup for a lab. There are several
other options such as <a href="https://docs.openstack.org/devstack/latest/index.html">DevStack</a>, <a href="https://docs.openstack.org/puppet-openstack-guide/latest/">Puppet-OpenStack</a> or <a href="https://docs.openstack.org/developer/kolla-ansible/">Kolla-ansible</a> and
all matters. But, Snap microstack takes only 2 minutes to deploy
OpenStack (instead of 30 minutes for other options).
</p>

<div class="note">
<ul class="org-ul">
<li>Devstack is good for OpenStack developers.</li>
<li>Puppet-OpenStack or Kolla-ansible are good for production
deployments.</li>
</ul>

</div>
</div>
</div>

<div id="outline-container-orgcf86307" class="outline-3">
<h3 id="orgcf86307"><span class="section-number-3">1.3</span> Setup OpenStack</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Install snap.
</p>
<pre class="example">
sudo apt install snapd

</pre>

<p>
Install OpenStack directly from the snap store.
</p>
<pre class="example">
sudo snap install microstack --classic --edge

</pre>

<p>
Then, ensure OpenStack services are running on your machine.
</p>

<div class="do">
<p>
Find the snap command that lists microstack OpenStack services and
there status? What is the purpose of each service?
</p>

<div class="solution">
<pre class="example">
snap services microstack

</pre>

<dl class="org-dl">
<dt>glance-*</dt><dd>Glance to manage VM images: <code>openstack image --help</code>.</dd>
<dt>horizon-*</dt><dd>OpenStack Web dashboard: <a href="http://localhost/">http://localhost/</a>.</dd>
<dt>keystone-*</dt><dd>Keystone to manage authentication and authorization
on OpenStack.</dd>
<dt>neutron-*</dt><dd>Neutron to manage networks: <code>openstack network --help</code>.</dd>
<dt>nova-*</dt><dd>Nova to manage VM: <code>openstack server --help</code>.</dd>
<dt>memcached</dt><dd>Cache used by all OpenStack services</dd>
<dt>mysqld</dt><dd>Database used by all OpenStack services</dd>
<dt>rabbitmq-server</dt><dd>Communication bus used by all OpenStack services</dd>
</dl>

</div>

</div>

<p>
And finally, execute the <code>setup.sh</code> file (require sudo).
</p>
<pre class="example">
./setup.sh

</pre>
</div>
</div>
</div>

<div id="outline-container-org4125150" class="outline-2">
<h2 id="sec:play-with-os"><a id="org4125150"></a><span class="section-number-2">2</span> Play with OpenStack</h2>
<div class="outline-text-2" id="text-sec:play-with-os">
</div>
<div id="outline-container-orgfe184e4" class="outline-3">
<h3 id="orgfe184e4"><span class="section-number-3">2.1</span> OpenStack Horizon Dashboard</h3>
<div class="outline-text-3" id="text-2-1">
<p>
One service deployed is the OpenStack dashboard (Horizon). On your
machine horizon is reachable from the web browser at <a href="http://localhost/">http://localhost/</a> with
the following credentials:
</p>
<ul class="org-ul">
<li>login: <code>admin</code></li>
<li>password: <code>keystone</code></li>
</ul>

<p>
From here, you can reach <code>Project &gt; Compute &gt; Instances &gt; Launch
Instance</code> and boot a virtual machine given the following information:
</p>
<ul class="org-ul">
<li>a name (e.g., <code>horizon-vm</code>)</li>
<li>an image (e.g., <code>cirros</code>)</li>
<li>a flavor to limit the resources of your instance (we recommend
<code>m1.tiny</code>)</li>
<li>and a network setting (must be <code>test</code>)</li>
</ul>

<p>
You should select options by clicking on the arrow on the right of
each possibility. When the configuration is OK, the <code>Launch Instance</code>
button should be enabled. After clicking on it, you should see the
instance in the <code>Active</code> state in less than a minute.
</p>

<p>
Now, you have several options to connect to your freshly deployed VM.
For instance, by clicking on its name, Horizon provides a virtual
console under the tab <code>Console</code>. Use the following credentials to
access the VM:
</p>
<ul class="org-ul">
<li>login: <code>cirros</code></li>
<li>password: <code>cubswin:)</code></li>
</ul>

<p>
Unfortunately this feature is disabled with Snap microstack. But as a
real DevOps, you will prefer to access to your vm by the command line
interface &#x2026;
</p>
</div>
</div>

<div id="outline-container-orgc185365" class="outline-3">
<h3 id="orgc185365"><span class="section-number-3">2.2</span> Unleash the Operator in You</h3>
<div class="outline-text-3" id="text-2-2">
<p>
While Horizon is helpful to discover OpenStack features, this is not
the tool of choice for a true operator. A true operator prefers
command line interface 😄. You are lucky, OpenStack provides such a
command line interface.
</p>

<p>
To use it, you need in most deployments to set your environment with
the OpenStack credentials, so that the command line won&rsquo;t bother you
by requiring credentials each time. you can retrieve this information
through the Horizon interface by clicking on the <code>admin</code> dropdown list
at the top right corner and get the &ldquo;OpenStack RC File V3&rdquo; (or by
clicking on that <a href="http://localhost/project/api_access/openrc/">link</a>).
</p>

<p>
To setup your environment please source this file.
</p>
<pre class="example">
source ./admin-openrc.sh

</pre>

<p>
You can then check that your environment is correctly set.
</p>
<pre class="example">
$ env|fgrep OS_|sort

OS_AUTH_URL=http://localhost:5000/v3/
OS_IDENTITY_API_VERSION=3
OS_INTERFACE=public
OS_PASSWORD=keystone
OS_PROJECT_DOMAIN_ID=default
OS_PROJECT_ID=76c02713292e4d3cba0625c9995a96aa
OS_PROJECT_NAME=admin
OS_REGION_NAME=microstack
OS_USER_DOMAIN_NAME=Default
OS_USERNAME=admin
</pre>

<p>
All operations to manage OpenStack are done through one single command
line, called <code>openstack</code>. Doing an <code>openstack --help</code> displays the
really long list of possibilities provided by this command. The
following gives you a selection of the most often used commands to
operate your Cloud:
</p>
<dl class="org-dl">
<dt>List OpenStack running services</dt><dd><code>openstack endpoint list</code></dd>
<dt>List images</dt><dd><code>openstack image list</code></dd>
<dt>List flavors</dt><dd><code>openstack flavor list</code></dd>
<dt>List networks</dt><dd><code>openstack network list</code></dd>
<dt>List computes</dt><dd><code>openstack hypervisor list</code></dd>
<dt>List VMs (running or not)</dt><dd><code>openstack server list</code></dd>
<dt>Get details on a specific VM</dt><dd><code>openstack server show &lt;vm-name&gt;</code></dd>
<dt>Start a new VM</dt><dd><code>openstack server create --image &lt;image-name&gt; --flavor &lt;flavor-name&gt; --nic net-id=&lt;net-id&gt; &lt;vm-name&gt;</code></dd>
<dt>View VMs logs</dt><dd><code>openstack console log show &lt;vm-name&gt;</code></dd>
</dl>

<p>
Using all these commands, you can use the CLI to start a new tiny
cirros VM called <code>cli-vm</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create <span style="color: #CC9393;">\</span>
  --image cirros <span style="color: #CC9393;">\</span>
  --flavor m1.tiny <span style="color: #CC9393;">\</span>
  --network test <span style="color: #CC9393;">\</span>
  cli-vm
</pre>
</div>

<p>
Then, display the information about your VM with the following
command:
</p>
<pre class="example">
openstack server show cli-vm

</pre>

<p>
Note in particular the <code>status</code> of your VM.
</p>
<pre class="example">
openstack server show cli-vm -c status -f json

</pre>

<p>
This status will go from <code>BUILD</code>: OpenStack is looking for the best
place to boot the VM; to <code>ACTIVE</code>: your VM is running (including the
boot phase). The status could also be <code>ERROR</code> if you are experiencing
hard times with your infrastructure.
</p>

<p>
Because an <code>ACTIVE</code> state includes the booting phase, you may wait for
one minute or two, the time for the VM finish booting. You can check
that by looking at its logs with <code>openstack console log show cli-vm</code>.
The VM finished to boot when last lines are:
</p>
<pre class="example">
=== cirros: current=0.3.4 uptime=16.56 ===
  ____               ____  ____
 / __/ __ ____ ____ / __ \/ __/
/ /__ / // __// __// /_/ /\ \
\___//_//_/  /_/   \____/___/
   http://cirros-cloud.net


login as 'cirros' user. default password: 'cubswin:)'. use 'sudo' for root.
cli-vm login:
</pre>

<p>
With the previous <code>openstack server create</code> command, the VM boots with
a private IP. Private IPs are used for communication between VMs,
meaning you cannot ping your VM from an external network (e.g., the
host machine). You have to manually affect a floating IP of the
<code>external</code> network to your machine if you want it to be pingable from
the host.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #DFAF8F;">ALLOCATED_FIP</span>=$<span style="color: #DCDCCC;">(</span>openstack floating ip create <span style="color: #CC9393;">\</span>
  -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
openstack server add floating ip cli-vm <span style="color: #CC9393;">"$ALLOCATED_FIP"</span>
</pre>
</div>

<p>
Then, ask again for the status of your VM and its IPs.
</p>
<pre class="example">
openstack server show cli-vm -c status -c addresses

</pre>

<div class="do">
<p>
Note the new IP address. From which network this IP comes? Ping
<code>cli-vm</code> on its floating IP.
</p>
<pre class="example">
echo "$ALLOCATED_FIP"
openstack subnet show external-subnet -c cidr -c allocation_pools
ping "$ALLOCATED_FIP"

</pre>

<p>
Does it work? Why? Hint: <a href="https://docs.openstack.org/neutron/latest/feature_classification/general_feature_support_matrix.html#operation_Security_Groups">OpenStack sets security groups by default</a>.
</p>

<div class="solution">
<p>
The IP comes from the network 10.20.20.0/24 serves on the host machine
by <code>br-ex</code>. Actually, Snap microstack <a href="https://github.com/CanonicalLtd/microstack/blob/130ff892b77b7a37268add7126216b31d3b5fd09/snap-overlay/bin/setup-br-ex">creates</a> a new virtual interface
named <code>br-ex</code> to manage the external network.
</p>

<pre class="example">
openstack subnet show external-subnet -c cidr -c allocation_pools
ip a |fgrep -B 2 10.20.20

</pre>

<p>
Regarding security rules, OpenStack is very conservative by default
and prevents ingress and egress traffic. The following rules allow
icmp packets and SSH connection on the VM.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #DFAF8F;">SECGROUP_ID</span>=<span style="color: #CC9393;">`openstack security group list --project admin -f value -c ID`</span>
openstack security group rule create $<span style="color: #DFAF8F;">SECGROUP_ID</span> --proto tcp --remote-ip <span style="color: #BFEBBF;">0.0.0.0/0</span> <span style="color: #CC9393;">\</span>
  --dst-port <span style="color: #BFEBBF;">22</span>
openstack security group rule create $<span style="color: #DFAF8F;">SECGROUP_ID</span> --proto icmp --remote-ip <span style="color: #BFEBBF;">0.0.0.0/0</span>
</pre>
</div>

</div>

</div>

<p>
Once you succeed to ping the vm, you should be able to SSH on it
</p>
<pre class="example">
ssh -l cirros "$ALLOCATED_FIP"

</pre>

<div class="do">
<p>
From the cirros, ping the outside world.
</p>
<pre class="example">
ping 8.8.8.8

</pre>

<p>
Does it work? Why? Hint: do a <code>tcpdump -nni br-ex icmp</code> to understand
how the packets flow. Idem on the NIC of your default route.
</p>

<div class="solution">
<p>
The network traffic on <code>br-ex</code> is not supposed to go out, and you have
to use the NIC of your default route (i.e., <code>ip r|fgrep default</code>,
e.g., <code>eth0</code> ) as a gateway (see,
<a href="https://www.systutorials.com/1372/setting-up-gateway-using-iptables-and-route-on-linux/">https://www.systutorials.com/1372/setting-up-gateway-using-iptables-and-route-on-linux/</a>).
</p>

<p>
You have to change the source IP of out packet (<code>10.20.20.*</code>) to
gateway&rsquo;s IP (e.g., <code>10.0.2.15</code> on my machine). The <code>iptables</code> will
then automatically change the replied packet&rsquo;s destination IP
(<code>10.0.2.15</code>) to the original source IP (<code>10.20.20.*</code>). This process
is called a SNAT and you can implement it with <code>iptables</code>.
</p>

<p>
First, enable Linux IP forwarding.
</p>
<pre class="example">
sudo sysctl -w net.ipv4.ip_forward=1

</pre>

<p>
Then, set up the SNAT with <code>iptables</code>.
</p>
<pre class="example">
sudo iptables -t nat -A POSTROUTING ! -d 10.20.20.0/24 -o eth0 -j SNAT --to-source 10.0.2.15

</pre>

</div>

</div>

<p>
Go on, and play with the <code>openstack</code> cli. For instance, list all
features offered by Nova with <code>openstack server --help</code> and try to
figure out how to:
</p>
<ol class="org-ol">
<li>SSH on <code>cli-vm</code> using its name rather than its IP;</li>
<li>Suspend and resume it;</li>
<li>Create a snapshot of <code>cli-vm</code>;</li>
<li>Boot a new machine <code>cli-vm-clone</code> from the snapshot.</li>
<li>Delete <code>cli-vm-clone</code>;</li>
</ol>

<div class="solution">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">1.</span>
openstack server ssh cli-vm -l cirros
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">2.</span>
openstack server suspend cli-vm; openstack server show cli-vm -c status
openstack server resume cli-vm; openstack server show cli-vm -c status
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">3.</span>
openstack server image create --name cli-vm-img cli-vm; openstack image list
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">4.</span>
openstack server create --wait --flavor m1.tiny <span style="color: #CC9393;">\</span>
  --network test --image cli-vm-img <span style="color: #CC9393;">\</span>
  cli-vm-clone
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">5.</span>
openstack server delete cli-vm-clone
</pre>
</div>

</div>
</div>
</div>

<div id="outline-container-org3819c75" class="outline-3">
<h3 id="org3819c75"><span class="section-number-3">2.3</span> In Encryption We Trust</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Any cirros VMs share the same credentials (i.e., <code>cirros</code>, <code>cubswin</code>)
which is a security problem. As an IaaS DevOps, you want that only
some clients can SSH on the VMs. Fortunately, OpenStack helps with the
management of SSH keys. OpenStack can generate a SSH key and push the
public counterpart on the VM. Therefore, doing a <code>ssh</code> on the VM will
use the SSH key instead of asking the client to fill the credentials.
</p>

<p>
Make an SSH key and store the private counterpart in <code>./admin.pem</code>.
Then, give that file the correct permission access.
</p>
<pre class="example">
openstack keypair create --private-key ./admin.pem admin
chmod 600 ./admin.pem

</pre>

<p>
Start a new VM and ask OpenStack to copy the public counterpart of
your SSH key in the <code>~/.ssh/authorized_keys</code> of the VM (i.e., note the
<code>--key-name admin</code>).
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image cirros <span style="color: #CC9393;">\</span>
  --flavor m1.tiny --network test <span style="color: #CC9393;">\</span>
  --key-name admin cli-vm-adminkey
</pre>
</div>

<p>
Attach it a floating IP.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #CC9393;">\</span>
  cli-vm-adminkey <span style="color: #CC9393;">\</span>
  $<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Now you can access your VM using SSH without filling credentials.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server ssh cli-vm-adminkey <span style="color: #CC9393;">\</span>
  --login cirros <span style="color: #CC9393;">\</span>
  --identity ./admin.pem
</pre>
</div>

<p>
Or directly with the <code>ssh</code> command
</p>
<pre class="example">
ssh -i ./admin.pem cirros@$(openstack server show cli-vm-adminkey -c addresses -f value | sed  -Er 's/test=.+ (10\.20\.20\.[0-9]+).*/\1/g')

</pre>

<div class="NOTE">
<p>
A regular <code>ssh</code> command looks like <code>ssh -i &lt;identity-file&gt;
&lt;name&gt;@&lt;server-ip&gt;</code>. The following OpenStack command followed by the
<code>sed</code> returns the floating IP of <code>cli-vm-adminkey</code>. You may have to
adapt it a bit according to your network cidr.
</p>
<pre class="example">
openstack server show cli-vm-adminkey -c addresses -f value | sed  -Er 's/test=.+ (10\.20\.20\.[0-9]+).*/\1/g'

</pre>

</div>
</div>
</div>

<div id="outline-container-org1e34eb7" class="outline-3">
<h3 id="org1e34eb7"><span class="section-number-3">2.4</span> The Art of Provisioning a VM</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Provisioning is the process that automatically installs software,
alters configurations, and more on the machine as part of the boot
process. On OpenStack, provisioning is achieved thanks to <a href="https://cloud-init.io/">Cloudinit</a>.
It is a program that runs at the boot time to customize the VM.
</p>

<p>
You have already used Cloudinit without even knowing it! The previous
command <code>openstack server create</code> with the <code>--identity</code> parameter
tells OpenStack to make the public counterpart of the SSH key
available to the VM. When the VM boots for the first time, Cloudinit
is (among other tasks) in charge of fetching this public SSH key from
OpenStack, and copy it to <code>~/.ssh/authorized_keys</code>. Beyond that,
Cloudinit is in charge of many aspects of the VM customization like
mounting volume, resizing file systems or setting an hostname (the
list of Cloudinit modules can be found <a href="http://cloudinit.readthedocs.io/en/latest/topics/modules.html">here</a>). Furthermore, Cloudinit
is able to run a bash script that will be executed on the VM as <code>root</code>
during the boot process.
</p>
</div>

<div id="outline-container-orgfab6ae9" class="outline-4">
<h4 id="sec:debian9-ftw"><a id="orgfab6ae9"></a><span class="section-number-4">2.4.1</span> Debian 9 FTW</h4>
<div class="outline-text-4" id="text-sec:debian9-ftw">
<p>
When it comes the time to deal with real applications, we cannot use
cirros VMs anymore. A Cirros VM is good for testing because it starts
fast and has a small memory footprint. However, do not expect to
launch MySQL or even <a href="https://github.com/busyloop/lolcat"><code>lolcat</code></a> on a cirros.
</p>

<p>
We are going to run several Debian9 VMs in this section. But, a
Debian9 takes a lot more of resources to run. For this reason, you
have to release all your resources before going further.
</p>

<p>
Delete currently running VMs.
</p>
<div class="org-src-container">
<pre class="src src-bash" id="orgfc1caea"><span style="color: #F0DFAF; font-weight: bold;">for</span> vm<span style="color: #F0DFAF; font-weight: bold;"> in</span> $<span style="color: #DCDCCC;">(</span>openstack server list -c Name -f value<span style="color: #DCDCCC;">)</span>; <span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #CC9393;">\</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"Deleting ${vm}..."</span>; <span style="color: #CC9393;">\</span>
  openstack server delete <span style="color: #CC9393;">"${vm}"</span>; <span style="color: #CC9393;">\</span>
<span style="color: #F0DFAF; font-weight: bold;">done</span>
</pre>
</div>

<p>
In the same manner, delete floating IPs.
</p>
<div class="org-src-container">
<pre class="src src-bash" id="org4b00d6e"><span style="color: #F0DFAF; font-weight: bold;">for</span> ip<span style="color: #F0DFAF; font-weight: bold;"> in</span> $<span style="color: #DCDCCC;">(</span>openstack floating ip list -c <span style="color: #CC9393;">"Floating IP Address"</span> -f value<span style="color: #DCDCCC;">)</span>; <span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #CC9393;">\</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"Deleting ${ip}..."</span>; <span style="color: #CC9393;">\</span>
  openstack floating ip delete <span style="color: #CC9393;">"${ip}"</span>; <span style="color: #CC9393;">\</span>
<span style="color: #F0DFAF; font-weight: bold;">done</span>
</pre>
</div>

<p>
Then, create a new flavor with 5 Go of Disk.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack flavor create --ram <span style="color: #BFEBBF;">2048</span> <span style="color: #CC9393;">\</span>
  --disk <span style="color: #BFEBBF;">5</span> --vcpus <span style="color: #BFEBBF;">1</span> --swap <span style="color: #BFEBBF;">1024</span> <span style="color: #CC9393;">\</span>
  --public m1.mini
</pre>
</div>

<p>
Download the Debian9 image with support of Cloudinit.
</p>
<div class="org-src-container">
<pre class="src src-bash">curl -L -o /tmp/debian-9.qcow2 <span style="color: #CC9393;">\</span>
  https://cdimage.debian.org/cdimage/openstack/current-9/debian-9-openstack-amd64.qcow2
</pre>
</div>

<p>
And import it into Glance.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack image create --disk-format=qcow2 <span style="color: #CC9393;">\</span>
  --container-format=bare --property <span style="color: #DFAF8F;">architecture</span>=x86_64 <span style="color: #CC9393;">\</span>
  --public --file /tmp/debian-9.qcow2 <span style="color: #CC9393;">\</span>
  debian-9
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c8ae9f" class="outline-4">
<h4 id="org8c8ae9f"><span class="section-number-4">2.4.2</span> Cloudinit in Action</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
To tell Cloudinit to load and execute a specific script at boot time,
you have to add the extra argument <code>--user-data
&lt;file/path/of/your/script&gt;</code> at the regular <code>openstack server create</code>
command.
</p>

<div class="do">
<p>
Start a new VM named <code>art-vm</code> based on the <code>debian-9</code> image and the
<code>m1.mini</code> flavor. The VM should load and execute the script <a href="#org434c8e1">1</a>
&#x2013; available under <a href="rsc/art.sh">rsc/art.sh</a> &#x2013; that installs the <a href="https://github.com/cmatsuoka/figlet"><code>figlet</code></a> and
<a href="https://github.com/busyloop/lolcat"><code>lolcat</code></a> softwares on the VM.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Cloudinit script available under <a href="rsc/art.sh">rsc/art.sh</a></label><pre class="src src-bash" id="org434c8e1"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">""</span> &gt;&gt; /etc/resolv.conf
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install figlet and lolcat</span>
apt update
apt install -y figlet lolcat
</pre>
</div>

<p>
You can follow the correct installation of software with:
</p>
<pre class="example">
watch openstack console log show --lines=20 art-vm

</pre>

<div class="solution">
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image debian-9 <span style="color: #CC9393;">\</span>
  --flavor m1.mini --network test <span style="color: #CC9393;">\</span>
  --key-name admin <span style="color: #CC9393;">\</span>
  --user-data ./rsc/art.sh <span style="color: #CC9393;">\</span>
  art-vm
</pre>
</div>

</div>

</div>

<p>
Then, attach it a floating IP.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #CC9393;">\</span>
  art-vm <span style="color: #CC9393;">\</span>
  $<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Hence, you can jump on the VM and call the <code>figlet</code> and <code>lolcat</code>
software.
</p>
<pre class="example">
~$ openstack server ssh art-vm \
  --login debian \
  --identity ./admin.pem

The authenticity of host '10.20.20.13 (10.20.20.13)' can't be established.
ECDSA key fingerprint is SHA256:WgAn+/gWYg9MkauihPyQGwC0LJ8sLWM/ySrUzN8cK9w.
Are you sure you want to continue connecting (yes/no)? yes

debian@art-vm:~$ figlet "The Art of Provisionning a VM" | lolcat
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6d066e8" class="outline-2">
<h2 id="org6d066e8"><span class="section-number-2">3</span> Deploy a Wordpress as a Service</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://wordpress.org/">Wordpress</a> is the most popular content management system (CMS) in use
on the Web. People use it to create websites, blogs or applications.
It is open-source, and based on PHP and MySQL under the hood.
</p>

<p>
A common Wordpress deployment consists in two machines:
</p>
<dl class="org-dl">
<dt><code>wordpress-db</code>  </dt><dd>A machine that contains the MySQL database for
Wordpress.</dd>
<dt><code>wordpress-app</code> </dt><dd>A machine that contains a web server and serves
the Wordpress CMS.</dd>
</dl>

<p>
The directory <code>rsc</code> provides bash scripts to deploy the MySQL database
and the web server. As the DevOps of OPH &#x2013; Online Polytech Hosting &#x2013;
your job is to automatize the deployment of a Wordpress on your
OpenStack. See the bash scripts in <a href="#org3077325">appendix</a> for more information.
Also, <a href="#sec:debian9-ftw">clean your environment</a> before going further.
</p>

<div class="do">
<p>
Make a bash script that automatically starts the <code>wordpress-db</code> and
<code>wordpress-app</code> VM.
</p>

</div>
</div>

<div id="outline-container-org1899024" class="outline-3">
<h3 id="org1899024"><span class="section-number-3">3.1</span> Wordpress MySQL Database&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></h3>
<div class="outline-text-3" id="text-3-1">
<p>
Start a VM with <code>wordpress-db</code> name, <code>debian-9</code> image, <code>m1.mini</code>
flavor, <code>test</code> network and <code>admin</code> key-pair. Also, provision your VM
with the <a href="rsc/install-mariadb.sh">rsc/install-mariadb.sh</a> script thanks to the <code>--user-data
./rsc/install-mariadb.sh</code> option.
</p>

<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image debian-9 <span style="color: #CC9393;">\</span>
  --flavor m1.mini --network test <span style="color: #CC9393;">\</span>
  --key-name admin <span style="color: #CC9393;">\</span>
  --user-data ./rsc/install-mariadb.sh <span style="color: #CC9393;">\</span>
  wordpress-db
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcebb86f" class="outline-3">
<h3 id="orgcebb86f"><span class="section-number-3">3.2</span> Wordpress Application&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></h3>
<div class="outline-text-3" id="text-3-2">
<p>
Start a VM with <code>wordpress-app</code> name, <code>debian-9</code> image, <code>m1.mini</code>
flavor, <code>test</code> network and <code>admin</code> key-pair. Also, provision your VM
with the <a href="rsc/install-wp.sh">rsc/install-wp.sh</a> script thanks to the <code>--user-data
./rsc/install-wp.sh</code> option. Note that you need to provide the IP
address of the <code>wordpress-db</code> to this script before running it.
</p>

<p>
Set the script with IP address of <code>wordpress-db</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash">sed -i <span style="color: #CC9393;">'13s|.*|DB_HOST="'</span>$<span style="color: #DCDCCC;">(</span>openstack server show wordpress-db -c addresses -f value | sed -Er <span style="color: #CC9393;">"s/test=//g"</span><span style="color: #DCDCCC;">)</span><span style="color: #CC9393;">'"|'</span> ./rsc/install-wp.sh
</pre>
</div>

<p>
Then, create <code>wordpress-app</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image debian-9 <span style="color: #CC9393;">\</span>
  --flavor m1.mini --network test <span style="color: #CC9393;">\</span>
  --key-name admin <span style="color: #CC9393;">\</span>
  --user-data ./rsc/install-wp.sh <span style="color: #CC9393;">\</span>
  wordpress-app
</pre>
</div>

<p>
Attach a floating ip to that VM.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #CC9393;">\</span>
  wordpress-app <span style="color: #CC9393;">\</span>
  $<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Finally, you can reach WordPress on <code>http://&lt;floating-ip&gt;/wp</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-org3077325" class="outline-2">
<h2 id="org3077325"><span class="section-number-2">4</span> Appendix</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orge177ae5" class="outline-3">
<h3 id="orge177ae5"><span class="section-number-3">4.1</span> Installs MariaDB on Debian 9</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/</span><span style="color: #F0DFAF; font-weight: bold;">env</span><span style="color: #7F9F7F;"> bash</span>
<span style="color: #5F7F5F;">#</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install and configure MariaDB for Debian 9.</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">""</span> &gt;&gt; /etc/resolv.conf
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters</span>
<span style="color: #DFAF8F;">DB_ROOTPASSWORD</span>=root
<span style="color: #DFAF8F;">DB_NAME</span>=wordpress    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Wordpress DB name</span>
<span style="color: #DFAF8F;">DB_USER</span>=silr         <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Wordpress DB user</span>
<span style="color: #DFAF8F;">DB_PASSWORD</span>=silr     <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Wordpress DB pass</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install MariaDB</span>
apt update -q
apt install -q -y mariadb-server mariadb-client

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Next line stops mysql install from popping up request for root password</span>
<span style="color: #DCDCCC; font-weight: bold;">export</span> <span style="color: #DFAF8F;">DEBIAN_FRONTEND</span>=noninteractive
sed -i <span style="color: #CC9393;">'s/127.0.0.1/0.0.0.0/'</span> /etc/mysql/mariadb.conf.d/50-server.cnf
systemctl restart mysql

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Setup MySQL root password and create a user and add remote privs to app subnet</span>
mysqladmin -u root password $<span style="color: #DCDCCC;">{</span><span style="color: #DFAF8F;">DB_ROOTPASSWORD</span><span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Create the wordpress database</span>
cat &lt;&lt; EOSQL | mysql -u root --password=$<span style="color: #DCDCCC;">{</span><span style="color: #DFAF8F;">DB_ROOTPASSWORD</span><span style="color: #DCDCCC;">}</span>
<span style="color: #F0DFAF; font-weight: bold;">FLUSH PRIVILEGES;</span>
<span style="color: #F0DFAF; font-weight: bold;">CREATE USER '${DB_USER}'@'localhost';</span>
<span style="color: #F0DFAF; font-weight: bold;">CREATE DATABASE ${DB_NAME};</span>
<span style="color: #F0DFAF; font-weight: bold;">SET PASSWORD FOR '${DB_USER}'@'localhost'=PASSWORD("${DB_PASSWORD}");</span>
<span style="color: #F0DFAF; font-weight: bold;">GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';</span>
<span style="color: #F0DFAF; font-weight: bold;">CREATE USER '${DB_USER}'@'%';</span>
<span style="color: #F0DFAF; font-weight: bold;">SET PASSWORD FOR '${DB_USER}'@'%'=PASSWORD("${DB_PASSWORD}");</span>
<span style="color: #F0DFAF; font-weight: bold;">GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';</span>
<span style="color: #F0DFAF; font-weight: bold;">EOSQL</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org52bc7d9" class="outline-3">
<h3 id="org52bc7d9"><span class="section-number-3">4.2</span> Installs Wordpress on Debian 9</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/</span><span style="color: #F0DFAF; font-weight: bold;">env</span><span style="color: #7F9F7F;"> bash</span>
<span style="color: #5F7F5F;">#</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install and configure Apache to serve Wordpress for Debian 9.</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">""</span> &gt;&gt; /etc/resolv.conf
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters</span>
<span style="color: #DFAF8F;">DB_NAME</span>=wordpress
<span style="color: #DFAF8F;">DB_USER</span>=silr
<span style="color: #DFAF8F;">DB_PASSWORD</span>=silr
<span style="color: #DFAF8F;">DB_HOST</span>=&lt;<span style="color: #D0BF8F; font-weight: bold;">TODO</span>&gt;

apt-get update -y
apt-get upgrade -y
apt-get install -q -y --force-yes wordpress apache2 curl

cat &lt;&lt; EOF &gt; /etc/apache2/sites-available/wp.conf
<span style="color: #F0DFAF; font-weight: bold;">Alias /wp/wp-content /var/lib/wordpress/wp-content</span>
<span style="color: #F0DFAF; font-weight: bold;">Alias /wp /usr/share/wordpress</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;Directory /usr/share/wordpress&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">    Options FollowSymLinks</span>
<span style="color: #F0DFAF; font-weight: bold;">    AllowOverride Limit Options FileInfo</span>
<span style="color: #F0DFAF; font-weight: bold;">    DirectoryIndex index.php</span>
<span style="color: #F0DFAF; font-weight: bold;">    Require all granted</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;/Directory&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;Directory /var/lib/wordpress/wp-content&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">    Options FollowSymLinks</span>
<span style="color: #F0DFAF; font-weight: bold;">    Require all granted</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;/Directory&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">EOF</span>

a2ensite wp
service apache2 reload

cat &lt;&lt; EOF &gt; /etc/wordpress/config-default.php
<span style="color: #F0DFAF; font-weight: bold;">&lt;?php</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_NAME', '${DB_NAME}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_USER', '${DB_USER}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_PASSWORD', '${DB_PASSWORD}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_HOST', '${DB_HOST}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('WP_CONTENT_DIR', '/var/lib/wordpress/wp-content');</span>
<span style="color: #F0DFAF; font-weight: bold;">?&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">EOF</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ronan-Alexandre Cherrueau, Adrien Lebre, Didier Iscovery</p>
<p class="email">Email: <a href="mailto:{firstname.lastname}@inria.fr">{firstname.lastname}@inria.fr</a></p>
<p class="github">Find a typo, wanna make a proposition:
 <a href="https://github.com/BeyondTheClouds/lectures/issues/new?title=[ptech18]">open an issue</a></p>
<p class="date">Last modification: 2018-12-14 Fri 16:58</p>
<p class="license">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.13) – theme by
 <a href="http://gongzhitaao.org/orgcss">http://gongzhitaao.org/orgcss</a></p>
</div>
</body>
</html>
