<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-12-09 Mon 15:42 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Operate Resources in Public and Private Clouds Thanks to OpenStack</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Ronan-Alexandre Cherrueau, Adrien Lebre, Didier Iscovery">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../../rsc/org.css" />
<link rel="stylesheet" type="text/css" href="../../rsc/org.css" />
<style>#table-of-contents .tag {display: none;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Operate Resources in Public and Private Clouds Thanks to OpenStack</h1>
</header><div class="abstract">
<p>
OpenStack has become the de-facto solution to operate compute, network
and storage resources in public and private clouds. In this lab, we
are going to:
</p>
<ul class="org-ul">
<li>Deploy an all-in-one OpenStack with <a href="https://opendev.org/x/microstack/">Snap microstack</a>.</li>
<li>Operate this OpenStack to manage IaaS resources (e.g., boot VMs,
setup a private Network).</li>
<li>Deploys a Wordpress as a Service.</li>
<li>Automatize all the stuff with the Heat template engine (i.e., manage
your cloud from your sofa!).</li>
</ul>

<p>
Find the slides of the lecture <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2018/os-polytech/docs/CloudFogEdgeIntro.pdf">here</a> and <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2018/os-polytech/docs/openstack-slides.pdf">there</a>. This document is an <a href="https://orgmode.org/">Org
mode</a> document, you can find its source <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/index.org">here</a>.
</p>

</div>

<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec:req-setup">1. Requirements and Setup</a>
<ul>
<li><a href="#org2aefd2f">1.1. Environment</a></li>
<li><a href="#sec:rscs-lab">1.2. Resources of the Lab</a></li>
<li><a href="#orgc575112">1.3. Setup OpenStack</a></li>
</ul>
</li>
<li><a href="#sec:play-with-os">2. Play with OpenStack (as an Admin)</a>
<ul>
<li><a href="#org088ad9f">2.1. OpenStack Horizon dashboard</a></li>
<li><a href="#sec:os-cli">2.2. Unleash the operator in you</a></li>
<li><a href="#sec:enc-trust">2.3. In encryption we trust</a></li>
<li><a href="#org5e02506">2.4. The art of contextualizing a VM</a></li>
<li><a href="#org7dac6f0">2.5. Run VMs at (near-)native speed</a></li>
</ul>
</li>
<li><a href="#orgfdf8cbd">3. Deploy a WordPress as a Service (as a DevOps)</a></li>
<li><a href="#orgf8de88b">4. Automatize the deployment with Heat</a>
<ul>
<li><a href="#org50e6fbe">4.1. Install the Heat orchestration service on microstack</a></li>
<li><a href="#orgdbfa668">4.2. Boot a VM</a></li>
<li><a href="#sec:heat-params">4.3. Need more flexibility: let&rsquo;s add parameters</a></li>
<li><a href="#sec:heat-outputs">4.4. Need to return values: let&rsquo;s use outputs!</a></li>
<li><a href="#org0dec031">4.5. Integrate <code>cloud-init</code></a></li>
<li><a href="#org9c48010">4.6. Dynamic configuration with <code>cloud-init</code> and parameters</a></li>
<li><a href="#sec:data-deps-rscs">4.7. Data dependency between resources</a></li>
<li><a href="#orgdf814ad">4.8. Nested templates</a></li>
<li><a href="#orgcf47a5f">4.9. Nested templates with data dependency</a></li>
<li><a href="#org7d33642">4.10. Other type of resources: floating IP</a></li>
</ul>
</li>
<li><a href="#orgc814de4">5. Deploy a WordPress as a Service (as a Heat DevOps)</a>
<ul>
<li><a href="#org2328605">5.1. Database VM template&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></a></li>
<li><a href="#org28a16ea">5.2. Web VM template&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></a></li>
<li><a href="#orgbf642e7">5.3. Wordpress application template&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></a></li>
</ul>
</li>
<li><a href="#orgf02c602">6. Appendix</a>
<ul>
<li><a href="#orge817e56">6.1. Install MariaDB on Debian 9</a></li>
<li><a href="#org0a38bba">6.2. Install Wordpress application on Debian 9</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org9d7f7da" class="outline-2">
<h2 id="sec:req-setup"><span class="section-number-2">1</span> Requirements and Setup</h2>
<div class="outline-text-2" id="text-sec:req-setup">
</div>
<div id="outline-container-org2aefd2f" class="outline-3">
<h3 id="org2aefd2f"><span class="section-number-3">1.1</span> Environment</h3>
<div class="outline-text-3" id="text-1-1">
<p>
To follow the lab you&rsquo;ll need a Linux (tested under Ubuntu 18.04) with
8 Go of RAM and a few Go of disk.
</p>

<p>
The lab makes use of <a href="https://opendev.org/x/microstack/">Snap microstack</a>: OpenStack in a Snap that you can
run locally on a single machine. Snap is the Canonical&rsquo;s App delivery
mechanism. It enables developers to bundle all dependencies into a
single app package. And so does Snap microstack for an all-in-one
OpenStack on your machine.
</p>

<p>
An all-in-one OpenStack means that your machine will contain both
services to <i>operate</i> and <i>host</i> virtualized resources. For instance,
the <code>nova-conductor</code> to operate the boot of a VM, and <code>nova-compute</code>
to host the VM. This is a good setup for a lab, but not for
production. There are several other options such as <a href="https://docs.openstack.org/devstack/latest/index.html">DevStack</a>,
<a href="https://docs.openstack.org/puppet-openstack-guide/latest/">Puppet-OpenStack</a> or <a href="https://docs.openstack.org/developer/kolla-ansible/">Kolla-ansible</a> and all matters. But, Snap
microstack takes only 2 minutes to deploy OpenStack (instead of 30
minutes for other options).
</p>

<div class="note">
<ul class="org-ul">
<li>Devstack is good for OpenStack developers.</li>
<li>Puppet-OpenStack or Kolla-ansible are good for production
deployments.</li>
</ul>

</div>
</div>
</div>

<div id="outline-container-orge437991" class="outline-3">
<h3 id="sec:rscs-lab"><span class="section-number-3">1.2</span> Resources of the Lab</h3>
<div class="outline-text-3" id="text-sec:rscs-lab">
<p>
Get the resources of the lab at <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/tp.tar.gz">https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/tp.tar.gz</a>.
</p>

<div class="org-src-container">
<pre class="src src-bash">curl -O https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/tp.tar.gz
mkdir ~/os-oph
tar xzf tp.tar.gz -C ~/os-oph
<span style="color: #DCDCCC; font-weight: bold;">cd</span> ~/os-oph
</pre>
</div>

<p>
The archive contains:
</p>
<dl class="org-dl">
<dt>index.txt</dt><dd>The current subject in text format.</dd>
<dt>setup.sh</dt><dd>Script that sets up the lab.</dd>
<dt>teardown.sh</dt><dd>Script that uninstalls the lab.</dd>
<dt>rsc</dt><dd>Resource directory with bash scripts useful for the lab.</dd>
</dl>
</div>
</div>

<div id="outline-container-orgc575112" class="outline-3">
<h3 id="orgc575112"><span class="section-number-3">1.3</span> Setup OpenStack</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Install snap.
</p>
<pre class="example">
sudo apt update
sudo apt install snapd
</pre>


<p>
Install OpenStack directly from the snap store.
</p>
<pre class="example">
sudo snap install microstack --classic --candidate
</pre>


<p>
Execute the <code>setup.sh</code> file with sudo to initialize OpenStack (setup
networks, flavors, images, &#x2026;).
</p>
<pre class="example">
sudo ./setup.sh
</pre>


<div class="do">
<p>
Then, ensure OpenStack services are running on your machine. Find the
snap command that lists microstack OpenStack services and there
status? What is the purpose of each service?
</p>

<div class="solution">
<pre class="example">
snap services microstack
</pre>


<dl class="org-dl">
<dt>glance-*</dt><dd>Glance to manage VM images: <code>openstack image --help</code>.</dd>
<dt>horizon-*</dt><dd>OpenStack Web dashboard: <a href="http://&lt;ip-of-your-lab-machine&gt;">http://&lt;ip-of-your-lab-machine&gt;</a>.</dd>
<dt>keystone-*</dt><dd>Keystone to manage authentication and authorization
on OpenStack.</dd>
<dt>neutron-*</dt><dd>Neutron to manage networks: <code>openstack network --help</code>.</dd>
<dt>nova-*</dt><dd>Nova to manage VM: <code>openstack server --help</code>.</dd>
<dt>memcached</dt><dd>Cache used by all OpenStack services</dd>
<dt>mysqld</dt><dd>Database used by all OpenStack services</dd>
<dt>rabbitmq-server</dt><dd>Communication bus used by all OpenStack services</dd>
</dl>

</div>

</div>
</div>
</div>
</div>

<div id="outline-container-orgd32e7e6" class="outline-2">
<h2 id="sec:play-with-os"><span class="section-number-2">2</span> Play with OpenStack (as an Admin)</h2>
<div class="outline-text-2" id="text-sec:play-with-os">
</div>
<div id="outline-container-org088ad9f" class="outline-3">
<h3 id="org088ad9f"><span class="section-number-3">2.1</span> OpenStack Horizon dashboard</h3>
<div class="outline-text-3" id="text-2-1">
<p>
One service deployed is the OpenStack dashboard (Horizon). On your own
machine, horizon is reachable from the web browser at
<a href="http://&lt;ip-of-your-lab-machine&gt;">http://&lt;ip-of-your-lab-machine&gt;</a> with the following credentials:
</p>
<ul class="org-ul">
<li>login: <code>admin</code></li>
<li>password: <code>keystone</code></li>
</ul>

<p>
From here, you can reach <code>Project &gt; Compute &gt; Instances &gt; Launch
Instance</code> and boot a virtual machine given the following information:
</p>
<ul class="org-ul">
<li>a name (e.g., <code>horizon-vm</code>)</li>
<li>an image (e.g., <code>cirros</code>)</li>
<li>a flavor to limit the resources of your instance (we recommend
<code>m1.tiny</code>)</li>
<li>and a network setting (must be <code>test</code>)</li>
</ul>

<p>
You should select options by clicking on the big arrow on the right of
each possibility. When the configuration is OK, the <code>Launch Instance</code>
button should be enabled. After clicking on it, you should see the
instance in the <code>Active</code> state in less than a minute.
</p>

<p>
Now, you have several options to connect to your freshly deployed VM.
For instance, after clicking on its name, Horizon provides a virtual
console under the <code>Console</code> tab. So, you can use the following
credentials to access the VM:
</p>
<ul class="org-ul">
<li>login: <code>cirros</code></li>
<li>password: <code>gocubsgo</code></li>
</ul>
<p>
Unfortunately this feature is disabled with Snap microstack. However,
as a <i>real DevOps</i>, you will prefer to access to your VM by the
command line interface &#x2026;
</p>
</div>
</div>

<div id="outline-container-org5b4e644" class="outline-3">
<h3 id="sec:os-cli"><span class="section-number-3">2.2</span> Unleash the operator in you</h3>
<div class="outline-text-3" id="text-sec:os-cli">
<p>
While Horizon is helpful to discover OpenStack features, this is not
the tool of choice for a real operator. A real operator prefers
command line interface üòÑ. You are lucky, OpenStack provides such a
command line interface.
</p>

<p>
To use it, you need to set your environment with the OpenStack
credentials, so that the command line won&rsquo;t bother you by requiring
credentials each time. You can retrieve this information through the
Horizon interface by clicking on the <code>admin</code> dropdown list at the top
right corner, and get the &ldquo;OpenStack RC File V3&rdquo; (or by following
<a href="http://&lt;ip-of-your-lab-machine&gt;/project/api_access/openrc/">http://&lt;ip-of-your-lab-machine&gt;/project/api_access/openrc/</a>).
</p>

<p>
To setup your environment please download and source this file on your
Lab machine.
</p>
<pre class="example">
source ./admin-openrc.sh
</pre>


<p>
You can then check that your environment is correctly set.
</p>
<div class="org-src-container">
<pre class="src src-bash">$ env|fgrep OS_|sort

<span style="color: #DFAF8F;">OS_AUTH_URL</span>==http://10.20.20.1:5000/v3/
<span style="color: #DFAF8F;">OS_IDENTITY_API_VERSION</span>=<span style="color: #BFEBBF;">3</span>
<span style="color: #DFAF8F;">OS_INTERFACE</span>=public
<span style="color: #DFAF8F;">OS_PASSWORD</span>=keystone
<span style="color: #DFAF8F;">OS_PROJECT_DOMAIN_ID</span>=default
<span style="color: #DFAF8F;">OS_PROJECT_ID</span>=<span style="color: #BFEBBF;">76c02713292e4d3cba0625c9995a96aa</span>
<span style="color: #DFAF8F;">OS_PROJECT_NAME</span>=admin
<span style="color: #DFAF8F;">OS_REGION_NAME</span>=microstack
<span style="color: #DFAF8F;">OS_USER_DOMAIN_NAME</span>=Default
<span style="color: #DFAF8F;">OS_USERNAME</span>=admin
</pre>
</div>

<p>
All operations to manage OpenStack are done through one unique command
line, called <code>openstack &lt;service&gt; &lt;action&gt; ...</code>. Doing an <code>openstack
--help</code> displays the <i>really long</i> list of services/possibilities
provided by this command. The following gives you a selection of the
most often used commands to operate your Cloud:
</p>
<dl class="org-dl">
<dt>List OpenStack running services</dt><dd><code>openstack endpoint list</code></dd>
<dt>List images</dt><dd><code>openstack image list</code></dd>
<dt>List flavors</dt><dd><code>openstack flavor list</code></dd>
<dt>List networks</dt><dd><code>openstack network list</code></dd>
<dt>List computes</dt><dd><code>openstack hypervisor list</code></dd>
<dt>List VMs (running or not)</dt><dd><code>openstack server list</code></dd>
<dt>Get details on a specific VM</dt><dd><code>openstack server show &lt;vm-name&gt;</code></dd>
<dt>Start a new VM</dt><dd><code>openstack server create --image &lt;image-name&gt; --flavor &lt;flavor-name&gt; --nic net-id=&lt;net-id&gt; &lt;vm-name&gt;</code></dd>
<dt>View VMs logs</dt><dd><code>openstack console log show &lt;vm-name&gt;</code></dd>
</dl>

<div class="do">
<p>
Using all these commands, you can use the CLI to start a new tiny
cirros VM called <code>cli-vm</code>.
</p>
<div class="solution">
<div class="org-src-container">
<pre class="src src-bash">openstack server create <span style="color: #CC9393;">\</span>
  --image cirros <span style="color: #CC9393;">\</span>
  --flavor m1.tiny <span style="color: #CC9393;">\</span>
  --network test <span style="color: #CC9393;">\</span>
  cli-vm
</pre>
</div>

</div>

</div>

<p>
Then, display the information about your VM with the following
command:
</p>
<pre class="example">
openstack server show cli-vm
</pre>


<p>
Note in particular the <code>status</code> of your VM (and how to extract that
information from the command line with the <code>-c</code> and <code>-f</code> options).
</p>
<pre class="example">
openstack server show cli-vm -c status -f json
</pre>


<p>
This status will go from <code>BUILD</code>: OpenStack is looking for the best
place to boot the VM; to <code>ACTIVE</code>: your VM is running. The status
could also be <code>ERROR</code> if you are experiencing hard times with your
infrastructure.
</p>

<p>
A VM in <code>ACTIVE</code> state still has to go through the <a href="http://www.tldp.org/LDP/intro-linux/html/sect_04_02.html">boot process and
init</a>. Hence, you may still have to wait for one minute or two that
your VM finishes to boot. You can check that your VM finished to boot
by looking at its logs with <code>openstack console log show cli-vm</code>. A
CirrOS VM finished to boot when last lines are:
</p>
<pre class="example">
=== cirros: current=0.4.0 latest=0.4.0 uptime=29.16 ===
  ____               ____  ____
 / __/ __ ____ ____ / __ \/ __/
/ /__ / // __// __// /_/ /\ \
\___//_//_/  /_/   \____/___/
   http://cirros-cloud.net


login as 'cirros' user. default password: 'gocubsgo'. use 'sudo' for root.
cli-vm login:
</pre>
</div>

<div id="outline-container-org2be9176" class="outline-4">
<h4 id="org2be9176"><span class="section-number-4">2.2.1</span> Make the world reaches the VM</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
With the previous <code>openstack server create</code> command, the VM boots with
a private IP. Private IPs are used for communication between VMs,
meaning you cannot ping your VM from an external network (e.g., the
Lab machine). To make your VM pingable from the Lab machine, you have
to manually affect it a floating IP of the <code>external</code> network.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #DFAF8F;">ALLOCATED_FIP</span>=$<span style="color: #DCDCCC;">(</span>openstack floating ip create <span style="color: #CC9393;">\</span>
  -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"${ALLOCATED_FIP}"</span>
openstack server add floating ip cli-vm <span style="color: #CC9393;">"${ALLOCATED_FIP}"</span>
</pre>
</div>

<p>
Then, ask again for the status of your VM and its IPs.
</p>
<pre class="example">
openstack server show cli-vm -c status -c addresses
</pre>


<div class="do">
<p>
Ping <code>cli-vm</code> on its floating IP.
</p>
<pre class="example">
ping "$ALLOCATED_FIP"
</pre>


<p>
Does it work? Why? Hint: <a href="https://docs.openstack.org/neutron/latest/feature_classification/general_feature_support_matrix.html#operation_Security_Groups">OpenStack sets security groups by default</a>.
Find the command that list the security group rules of the <code>admin</code>
project. # (i.e., <code>openstack project show admin</code>).
</p>

<div class="solution">
<p>
Regarding security rules, OpenStack is very conservative by default
and prevents ingress and egress traffic. Spot the <code>None</code> value at <code>IP
Protocol</code>, and <code>0.0.0.0/0</code> <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a> at <code>IP Range</code>, in the result table of
the command that list security group rules of the admin project: These
values should be interpreted as <i>&ldquo;<code>None</code> protocol on any (<code>0.0.0.0/0</code>)
network is allowed&rdquo;</i>.
</p>
<div class="org-src-container">
<pre class="src src-bash">$ <span style="color: #DFAF8F;">SECGROUP_ID</span>=<span style="color: #CC9393;">`openstack security group list --project admin -f value -c ID`</span>
$ openstack security group rule list -c ID -c <span style="color: #CC9393;">"IP Protocol"</span> -c <span style="color: #CC9393;">"IP Range"</span> $<span style="color: #DFAF8F;">SECGROUP_ID</span>

+--------------------------------------+-------------+-----------+
| ID                                   | IP Protocol | IP Range  |
+--------------------------------------+-------------+-----------+
| <span style="color: #BFEBBF;">473c2c5e-bd23-4b56-9d33-2276e483ac33</span> | None        | <span style="color: #BFEBBF;">0.0.0.0/0</span> |
| <span style="color: #BFEBBF;">5b08ae18-ed18-4a82-8382-aa1cfc3effff</span> | None        | ::/0      |
| <span style="color: #BFEBBF;">9b104d51-61d2-4a0f-bac4-36b5803ac721</span> | None        | ::/0      |
| ecd3aa5a-acde-4e9f-9738-14945bcee258 | None        | <span style="color: #BFEBBF;">0.0.0.0/0</span> |
+--------------------------------------+-------------+-----------+
</pre>
</div>

</div>

<p>
Then, make it work for <code>10.20.20.0/24</code> network. See examples of
security groups rules in the <a href="https://docs.openstack.org/neutron/latest/admin/deploy-lb-selfservice.html#verify-network-operation">neutron doc</a>.
</p>

<div class="solution">
<p>
To make it work, you have to setup new rules in the security group of
the <code>admin</code> project. The following rules allow ICMP packets (for ping)
and TCP on port 22 (for SSH connection) on the VM.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack security group rule create $<span style="color: #DFAF8F;">SECGROUP_ID</span> --proto icmp --remote-ip <span style="color: #BFEBBF;">10.20.20.0/24</span>
openstack security group rule create $<span style="color: #DFAF8F;">SECGROUP_ID</span> --proto tcp --remote-ip <span style="color: #BFEBBF;">10.20.20.0/24</span> <span style="color: #CC9393;">\</span>
  --dst-port <span style="color: #BFEBBF;">22</span>
</pre>
</div>

</div>

</div>

<p>
Once you succeed to ping the vm, you should also be able to SSH on it.
</p>
<pre class="example">
ssh -l cirros "$ALLOCATED_FIP"
</pre>
</div>
</div>

<div id="outline-container-org77ebb4e" class="outline-4">
<h4 id="org77ebb4e"><span class="section-number-4">2.2.2</span> Make the VM reaches the world</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
From the cirros, ping the outside world.
</p>
<pre class="example">
ping 8.8.8.8  # GOOGLE could you HEAR me?!
</pre>


<div class="do">
<p>
Does it work? Why? To help you in your diagnosis, here is a list of
hints to check:
</p>
<ul class="org-ul">
<li><p>
Ping Google and the VM <b>from the Lab machine</b>. The ping should work
for both. What does it mean for the Lab machine regarding
communications between VMs and the Internet?
</p>
<div class="solution">
<pre class="example">
ping -c 2 8.8.8.8; ping -c 2 $ALLOCATED_FIP
</pre>

<p>
The ping from the Lab machine works for both Google and the VM.
Thus, the Lab machine <i>could be a gateway</i> between VMs and the
Internet.
</p>

</div></li>

<li><p>
Note the IP address of <code>$ALLOCATED_FIP</code>. From which network this IP
comes? Which NIC serves that network on the Lab machine?
</p>
<div class="solution">
<pre class="example">
echo "$ALLOCATED_FIP"
openstack subnet show external-subnet -c cidr -c allocation_pools
ip address | fgrep -B 2 10.20.20
</pre>

<p>
The IP of the VM comes from the network 10.20.20.0/24, which is
served on the Lab machine by <code>br-ex</code>.
</p>

</div></li>

<li><p>
Do a <code>tcpdump</code> on that NIC. Do you see the ICMP packets from
<code>$ALLOCATED_FIP</code> that flow over that NIC?
</p>
<div class="solution">
<pre class="example">
sudo tcpdump -nni br-ex icmp
</pre>

<p>
The <code>tcpdump</code> on <code>br-ex</code> shows ping <code>echo request</code> packets, but no
<code>echo reply</code>. So the packets are lost somewhere&#x2026;. In other words,
the Lab machine does not play its role of gateway between VMs and
the Internet.
</p>

</div></li>

<li><p>
Find the route that forward packets to the Internet on Lab machine.
Do a <code>tcpdump</code> on the NIC that servers that route. Do you see the
ICMP packets flow over that NIC?
</p>
<div class="solution">
<p>
To ensure that something is wrong on the Lab machine regarding its
role of gateway between VMs and the Internet, let&rsquo;s find the route
that forwards Google packets out of the Lab machine.
</p>
<pre class="example">
$ ip route

default via 192.168.121.1 dev eth0 proto dhcp src 192.168.121.77 metric 100
10.20.20.0/24 dev br-ex proto kernel scope link src 10.20.20.1
192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.77
192.168.121.1 dev eth0 proto dhcp scope link src 192.168.121.77 metric 100
</pre>

<p>
The command does not show up an <i>explicit</i> route for <code>8.8.8.0/9</code>
packets. This means that packets are supposed to flow through the
<i>default</i> route served by the <code>eth0</code> NIC on my machine.
</p>

<p>
Next, do a <code>tcpdump</code> on that NIC to see if the ICMP packet go
through it.
</p>
<pre class="example">
sudo tcpdump -nni eth0 icmp
</pre>

<p>
Nothing appears. So ICMP packet are lost somewhere between <code>br-ex</code>
and <code>eth0</code>, despite the first hint.
</p>

<p>
To put it differently, the Lab machine does not forward the incoming
traffic on <code>br-ex</code> to <code>eth0</code>. And this is normal, there is <a href="https://serverfault.com/questions/749682/ip-forwarding-on-linux-anything-important-to-make-sure-to-do-or-know">no reason</a>
for Linux to enable this by default. However in our case, we have to
activate it. This is called <i>Kernel IP Forwarding</i>, and it could be
set up with the next command (or <code>echo 1 &gt;
  /proc/sys/net/ipv4/ip_forward</code>).
</p>
<pre class="example">
sudo sysctl -w net.ipv4.ip_forward=1
</pre>


<div class="note">
<p>
Sometimes activating the kernel IP forwarding is not enough,
<a href="http://www.microhowto.info/howto/enable_forwarding_of_ipv4_packets.html#idp17360">especially in case of firewalling</a>. A common place to perform packet
filtering of routed traffic is in the <code>FORWARD</code> chain of the filter
table.
</p>
<pre class="example">
sudo iptabes -t filter -L FORWARD -n
</pre>


<p>
If a rule drops packet, then it is mandatory to accept them with a
new rule.
</p>
<pre class="example">
iptables -A FORWARD -j ACCEPT
</pre>

</div>

</div></li>

<li><p>
After making the packets flow on the second NIC, is everything OK
with the IP address of the source in the <code>tcpdump</code> on <code>eth0</code>?
</p>
<div class="solution">
<p>
From now, the ping of Google from the VM reaches Internet via <code>eth0</code>
(as seen by <code>tcpdump -nni eth0 icmp</code>). Unfortunately, it still
doesn&rsquo;t do the trick, because the packet goes out with the
<code>10.20.20.*</code> source address. For this reason, Google sees <code>ICMP echo
  request</code> incoming packets from <code>10.20.20.*</code> and hence, replies <code>ICMP
  echo reply</code> to <code>10.20.20.*</code> which does not makes sense out of a
private network.
</p>

<p>
You have to change the source IP of out packet (<code>10.20.20.*</code>) to
gateway&rsquo;s IP (i.e., Your lab machine). The <code>iptables</code> will then
automatically change the replied packet&rsquo;s destination IP
(<code>&lt;ip-of-your-Lab-machine&gt;</code>) to the original source IP
(<code>10.20.20.*</code>). This process is called a SNAT and you can implement
it with <code>iptables</code> (see,
<a href="https://www.systutorials.com/1372/setting-up-gateway-using-iptables-and-route-on-linux/">https://www.systutorials.com/1372/setting-up-gateway-using-iptables-and-route-on-linux/</a>).
</p>

<p>
Set up the SNAT with <code>iptables</code>. The following rule should be read
&ldquo;In the <code>nat</code> table, for packets that leave the machine (<code>-A
  POSTROUTING</code>) and incoming from network <code>10.20.20.0/24</code> (<code>-s</code>) and
not at destination of the network <code>10.20.20.0/24</code> (<code>! -d</code>), then
replace the sender&rsquo;s address by the router&rsquo;s address (<code>-j
  MASQUERADE</code>).&rdquo;
</p>

<pre class="example">
sudo iptables -t nat -A POSTROUTING -s 10.20.20.0/24 ! -d 10.20.20.0/24 -j MASQUERADE
</pre>

</div></li>
</ul>

</div>

<p>
Go on, and play with the <code>openstack</code> cli. For instance, list all
features offered by Nova with <code>openstack server --help</code> and try to
figure out how to:
</p>
<ol class="org-ol">
<li>SSH on <code>cli-vm</code> using its name rather than its IP;</li>
<li>Suspend and resume it;</li>
<li>Create a snapshot of <code>cli-vm</code>;</li>
<li>Boot a new machine <code>cli-vm-clone</code> from the snapshot.</li>
<li>Delete <code>cli-vm-clone</code>;</li>
</ol>

<div class="solution">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">1.</span>
openstack server ssh cli-vm -l cirros
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">2.</span>
openstack server suspend cli-vm; openstack server show cli-vm -c status
openstack server resume cli-vm; openstack server show cli-vm -c status
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">3.</span>
openstack server image create --name cli-vm-img cli-vm; openstack image list
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">4.</span>
openstack server create --wait --flavor m1.tiny <span style="color: #CC9393;">\</span>
  --network test --image cli-vm-img <span style="color: #CC9393;">\</span>
  cli-vm-clone
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">5.</span>
openstack server delete cli-vm-clone
</pre>
</div>

</div>
</div>
</div>
</div>

<div id="outline-container-org35efedf" class="outline-3">
<h3 id="sec:enc-trust"><span class="section-number-3">2.3</span> In encryption we trust</h3>
<div class="outline-text-3" id="text-sec:enc-trust">
<p>
Any cirros VMs share the same credentials (i.e., <code>cirros</code>, <code>gocubsgo</code>)
which is a security problem. As a IaaS DevOps, you want that only some
clients can SSH on the VMs. Fortunately, OpenStack helps with the
management of SSH keys. OpenStack can generate a SSH key and push the
public counterpart on the VM. Therefore, doing a <code>ssh</code> on the VM will
use the SSH key instead of asking the client to fill the credentials.
</p>

<p>
Make an SSH key and store the private counterpart in <code>./admin.pem</code>.
Then, give that file the correct permission access.
</p>
<pre class="example">
openstack keypair create --private-key ./admin.pem admin
chmod 600 ./admin.pem
</pre>


<p>
Start a new VM and ask OpenStack to copy the public counterpart of
your SSH key in the <code>~/.ssh/authorized_keys</code> of the VM (i.e., note the
<code>--key-name admin</code>).
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image cirros <span style="color: #CC9393;">\</span>
  --flavor m1.tiny --network test <span style="color: #CC9393;">\</span>
  --key-name admin cli-vm-adminkey
</pre>
</div>

<p>
Attach it a floating IP.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #CC9393;">\</span>
  cli-vm-adminkey <span style="color: #CC9393;">\</span>
  $<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Now you can access your VM using SSH without filling credentials.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server ssh cli-vm-adminkey <span style="color: #CC9393;">\</span>
  --login cirros <span style="color: #CC9393;">\</span>
  --identity ./admin.pem
</pre>
</div>

<div class="note">
<p>
Or directly with the <code>ssh</code> command &#x2014; for bash lovers ‚ù§.
</p>
<pre class="example">
ssh -i ./admin.pem -l cirros $(openstack server show cli-vm-adminkey -c addresses -f value | sed  -Er 's/test=.+ (10\.20\.20\.[0-9]+).*/\1/g')
</pre>


<p>
A regular <code>ssh</code> command looks like <code>ssh -i &lt;identity-file&gt; -l &lt;name&gt;
&lt;server-ip&gt;</code>. The OpenStack command followed by the <code>sed</code> returns the
floating IP of <code>cli-vm-adminkey</code>. You may have to adapt it a bit
according to your network cidr.
</p>
<pre class="example">
openstack server show cli-vm-adminkey -c addresses -f value | sed  -Er 's/test=.+ (10\.20\.20\.[0-9]+).*/\1/g'
</pre>

</div>
</div>
</div>

<div id="outline-container-org5e02506" class="outline-3">
<h3 id="org5e02506"><span class="section-number-3">2.4</span> The art of contextualizing a VM</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Contextualizing is the process that automatically installs software,
alters configurations, and does more on a machine as part of its boot
process. On OpenStack, contextualizing is achieved thanks to
<a href="https://cloud-init.io/"><code>cloud-init</code></a>. It is a program that runs at the boot time to customize
the VM.
</p>

<p>
You have already used <code>cloud-init</code> without even knowing it! The
previous command <code>openstack server create</code> with the <code>--identity</code>
parameter tells OpenStack to make the public counterpart of the SSH
key available to the VM. When the VM boots for the first time,
<code>cloud-init</code> is (among other tasks) in charge of fetching this public
SSH key from OpenStack, and copy it to <code>~/.ssh/authorized_keys</code>.
Beyond that, <code>cloud-init</code> is in charge of many aspects of the VM
customization like mounting volume, resizing file systems or setting
an hostname (the list of <code>cloud-init</code> modules can be found <a href="http://cloudinit.readthedocs.io/en/latest/topics/modules.html">here</a>).
Furthermore, <code>cloud-init</code> is able to run a bash script that will be
executed on the VM as <code>root</code> during the boot process.
</p>
</div>

<div id="outline-container-org0fe709a" class="outline-4">
<h4 id="sec:debian9-ftw"><span class="section-number-4">2.4.1</span> Debian 9 FTW</h4>
<div class="outline-text-4" id="text-sec:debian9-ftw">
<p>
When it comes the time to deal with real applications, we cannot use
cirros VMs anymore. A Cirros VM is good for testing because it starts
fast and has a small memory footprint. However, do not expect to
launch <a href="https://en.wikipedia.org/wiki/MariaDB">MariaDB</a> or even <a href="https://github.com/busyloop/lolcat"><code>lolcat</code></a> on a cirros.
</p>

<p>
We are going to run several Debian9 VMs in this section. But, a
Debian9 takes a lot more of resources to run. For this reason, you may
want to release all your resources before going further.
</p>

<div class="org-src-container">
<pre class="src src-bash" id="org66d8b59"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Delete VMs</span>
<span style="color: #F0DFAF; font-weight: bold;">for</span> vm<span style="color: #F0DFAF; font-weight: bold;"> in</span> $<span style="color: #DCDCCC;">(</span>openstack server list -c ID -f value<span style="color: #DCDCCC;">)</span>; <span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #CC9393;">\</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"Deleting ${vm}..."</span>; <span style="color: #CC9393;">\</span>
  openstack server delete <span style="color: #CC9393;">"${vm}"</span>; <span style="color: #CC9393;">\</span>
<span style="color: #F0DFAF; font-weight: bold;">done</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Releasing floating IPs</span>
<span style="color: #F0DFAF; font-weight: bold;">for</span> ip<span style="color: #F0DFAF; font-weight: bold;"> in</span> $<span style="color: #DCDCCC;">(</span>openstack floating ip list -c <span style="color: #CC9393;">"Floating IP Address"</span> -f value<span style="color: #DCDCCC;">)</span>; <span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #CC9393;">\</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"Releasing ${ip}..."</span>; <span style="color: #CC9393;">\</span>
  openstack floating ip delete <span style="color: #CC9393;">"${ip}"</span>; <span style="color: #CC9393;">\</span>
<span style="color: #F0DFAF; font-weight: bold;">done</span>
</pre>
</div>

<p>
Then, download the Debian9 image with support of <code>cloud-init</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash">curl -L -o /tmp/debian-9.qcow2 <span style="color: #CC9393;">\</span>
  https://cdimage.debian.org/cdimage/openstack/current-9/debian-9-openstack-amd64.qcow2
</pre>
</div>

<div class="do">
<p>
Import the image into Glance; name it <code>debian-9</code>. Use <code>openstack image
create --help</code> for creation arguments. Find values example with
<code>openstack image show cirros</code>.
</p>
<div class="solution">
<div class="org-src-container">
<pre class="src src-bash">openstack image create --disk-format=qcow2 <span style="color: #CC9393;">\</span>
  --container-format=bare --property <span style="color: #DFAF8F;">architecture</span>=x86_64 <span style="color: #CC9393;">\</span>
  --public --file /tmp/debian-9.qcow2 <span style="color: #CC9393;">\</span>
  debian-9
</pre>
</div>

</div>

<p>
And, create a new <code>m1.mini</code> flavor with 5 Go of Disk, 2 Go of RAM, 2
VCPU and 1 Go of swap. Use <code>openstack flavor create --help</code> for
creation arguments.
</p>
<div class="solution">
<div class="org-src-container">
<pre class="src src-bash">openstack flavor create --ram <span style="color: #BFEBBF;">2048</span> <span style="color: #CC9393;">\</span>
  --disk <span style="color: #BFEBBF;">5</span> --vcpus <span style="color: #BFEBBF;">2</span> --swap <span style="color: #BFEBBF;">1024</span> <span style="color: #CC9393;">\</span>
  --public m1.mini
</pre>
</div>

</div>

</div>
</div>
</div>

<div id="outline-container-org1e2da69" class="outline-4">
<h4 id="sec:cloud-init"><span class="section-number-4">2.4.2</span> <code>cloud-init</code> in Action</h4>
<div class="outline-text-4" id="text-sec:cloud-init">
<p>
To tell <code>cloud-init</code> to load and execute a specific script at boot
time, you should append the <code>--user-data &lt;file/path/of/your/script&gt;</code>
extra argument to the regular <code>openstack server create</code> command.
</p>

<div class="do">
<p>
Start a new VM named <code>art-vm</code> based on the <code>debian-9</code> image and the
<code>m1.mini</code> flavor. The VM should load and execute the script <a href="#org8a8b331">1</a>
&#x2013; available under <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/rsc/art.sh"><code>rsc/art.sh</code></a> &#x2013; that installs the <a href="https://github.com/cmatsuoka/figlet"><code>figlet</code></a> and
<a href="https://github.com/busyloop/lolcat"><code>lolcat</code></a> softwares on the VM.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><code>cloud-init</code> script available under <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/rsc/art.sh"><code>rsc/art.sh</code></a></label><pre class="src src-bash" id="org8a8b331"><span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/</span><span style="color: #F0DFAF; font-weight: bold;">env</span><span style="color: #7F9F7F;"> bash</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">""</span> &gt; /etc/resolv.conf
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install figlet and lolcat</span>
apt update
apt install -y figlet lolcat
</pre>
</div>

<div class="solution">
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image debian-9 <span style="color: #CC9393;">\</span>
  --flavor m1.mini --network test <span style="color: #CC9393;">\</span>
  --key-name admin <span style="color: #CC9393;">\</span>
  --user-data ./rsc/art.sh <span style="color: #CC9393;">\</span>
  art-vm
</pre>
</div>

</div>

<p>
You can follow the correct installation of software with:
</p>
<pre class="example">
watch openstack console log show --lines=20 art-vm
</pre>


<p>
Could you notice <i>when</i> the VM has finished to boot based on the
<code>console log</code> output?
</p>
<div class="solution">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">wait_contextualization</span> <span style="color: #DCDCCC;">{</span>
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Get the log</span>
  <span style="color: #DCDCCC; font-weight: bold;">local</span> <span style="color: #DFAF8F;">vm</span>=<span style="color: #CC9393;">"$1"</span>
  <span style="color: #DCDCCC; font-weight: bold;">local</span> <span style="color: #DFAF8F;">console_log</span>=$<span style="color: #BFEBBF;">(</span>openstack console log show --lines=<span style="color: #BFEBBF;">20</span> <span style="color: #CC9393;">"${vm}"</span><span style="color: #BFEBBF;">)</span>

  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Loop till cloud-init finished</span>
  <span style="color: #DCDCCC; font-weight: bold;">local</span> <span style="color: #DFAF8F;">cloudinit_end_rx</span>=<span style="color: #CC9393;">"Cloud-init v\. .\+ finished"</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"Waiting for cloud-init to finish..."</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"Current status is:"</span>
  <span style="color: #F0DFAF; font-weight: bold;">while ! </span><span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"${console_log}"</span>|grep -q <span style="color: #CC9393;">"${cloudinit_end_rx}"</span>
  <span style="color: #F0DFAF; font-weight: bold;">do</span>
      <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"${console_log}"</span>
      sleep <span style="color: #BFEBBF;">5</span>

      <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Compute the new console log before clearing</span>
      <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">so the screen is not blank for two long.</span>
      <span style="color: #DCDCCC; font-weight: bold;">local</span> <span style="color: #DFAF8F;">new_console_log</span>=$<span style="color: #BFEBBF;">(</span>openstack console log show --lines=<span style="color: #BFEBBF;">20</span> <span style="color: #CC9393;">"${vm}"</span><span style="color: #BFEBBF;">)</span>

      <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Clear the screen (`cuu1` move cursor up by one line, `el`</span>
      <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">clear the line)</span>
      <span style="color: #F0DFAF; font-weight: bold;">while </span><span style="color: #DCDCCC; font-weight: bold;">read</span> -r line; <span style="color: #F0DFAF; font-weight: bold;">do</span>
          tput cuu1; tput el
      <span style="color: #F0DFAF; font-weight: bold;">done</span> &lt;&lt;&lt; <span style="color: #CC9393;">"${console_log}"</span>

      <span style="color: #DFAF8F;">console_log</span>=<span style="color: #CC9393;">"${new_console_log}"</span>
  <span style="color: #F0DFAF; font-weight: bold;">done</span>

  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">cloud-init finished</span>
  <span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"${console_log}"</span>|grep <span style="color: #CC9393;">"${CLOUDINIT_END_RX}"</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
Then use it as the following.
</p>
<pre class="example">
wait_contextualization art-vm
</pre>

</div>

</div>

<p>
Then, attach it a floating IP.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #CC9393;">\</span>
  art-vm <span style="color: #CC9393;">\</span>
  $<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Hence, you can jump on the VM and call the <code>figlet</code> and <code>lolcat</code>
software.
</p>
<pre class="example">
$ openstack server ssh art-vm \
    --login debian \
    --identity ./admin.pem

The authenticity of host '10.20.20.13 (10.20.20.13)' can't be established.
ECDSA key fingerprint is SHA256:WgAn+/gWYg9MkauihPyQGwC0LJ8sLWM/ySrUzN8cK9w.
Are you sure you want to continue connecting (yes/no)? yes

debian@art-vm:~$ figlet "The Art of Contextualizing a VM" | lolcat
</pre>
</div>
</div>
</div>

<div id="outline-container-org7dac6f0" class="outline-3">
<h3 id="org7dac6f0"><span class="section-number-3">2.5</span> Run VMs at (near-)native speed</h3>
<div class="outline-text-3" id="text-2-5">
<p>
Every time you do an <code>openstack server create ...</code>, your request hits,
at some point, the <code>nova</code> services. It starts by the <code>nova-api</code> that
processes the REST request. The API, in turns, calls the
<code>nova-conductor</code> that orchestrates the boot: performs some checks,
finds eligible computes and chooses one to transmit the boot order to
its <code>nova-compute</code>. Finally, the <code>nova-compute</code> asks to the underlying
hypervisor to start the VM.
</p>

<p>
In your current setup, the hypervisor of your <code>nova-compute</code> runs
<a href="https://en.wikipedia.org/wiki/QEMU">QEMU</a>. QEMU is a free emulator for hardware virtualization. It supports
a large variety of guest operating systems, but the emulation is a bit
slow. Fortunately, QEMU can be used with <a href="http://www.linux-kvm.org/">KVM</a> to run virtual machines
at near-native speed. KVM (Kernel-based Virtual Machine) is a free
full virtualization solution for Linux that takes advantage of x86
hardware extensions (Intel VT or AMD-V).
</p>

<p>
To check if the x86 of your Lab machine provides hardware
virtualization, execute the following command.
</p>
<pre class="example">
egrep -c '(vmx|svm)' /proc/cpuinfo
</pre>

<p>
If it outputs a number greater than 0, then proceed with the following
to speed up the VMs execution. Seek the <a href="https://docs.openstack.org/nova/stein/admin/configuration/hypervisor-kvm.html">Nova documentation</a> for some
help.
</p>

<div class="do">
<ul class="org-ul">
<li><p>
Check that the KVM kernel module is loaded, and load it otherwise.
</p>
<div class="solution">
<p>
<i>From the <a href="https://docs.openstack.org/nova/stein/admin/configuration/hypervisor-kvm.html#for-x86-based-systems">Nova documentation</a>:</i> Do the following command to list the
loaded kernel modules and verify that the KVM modules are loaded.
</p>
<pre class="example">
lsmod|fgrep kvm
</pre>

<p>
If the output includes <code>kvm_intel</code> or <code>kvm_amd</code>, the KVM hardware
virtualization modules are loaded and your kernel meets the module
requirements for OpenStack Compute.
</p>

<p>
If the output does not show that the KVM module is loaded, run the
next command.
</p>
<pre class="example">
modprobe -a kvm
modprobe -a kvm-intel  # for Intel
modprobe -a kvm-amd    # for amd
</pre>

</div></li>

<li><p>
Change the configuration of <code>nova-compute</code> hypervisor (file
<code>/var/snap/microstack/common/etc/nova/nova.conf.d/hypervisor.conf</code>)
to support KVM and restart it.
</p>
<div class="solution">
<pre class="example">
NOVA_HYPERV_CONF=/var/snap/microstack/common/etc/nova/nova.conf.d/hypervisor.conf
sudo sed -i 's|virt_type.\+|virt_type = kvm|' $NOVA_HYPERV_CONF
sudo sed -i 's|cpu_mode.\+|cpu_mode = host-passthrough|' $NOVA_HYPERV_CONF
sudo snap restart microstack.nova-compute
</pre>

</div></li>
</ul>

</div>

<p>
Finally, create a new VM such as in the <a href="#sec:cloud-init">previous section</a> and
appreciate how fast your VM displays the <code>figlet "The Art of
Contextualizing a VM with KVM" | lolcat</code> command.
</p>
</div>
</div>
</div>

<div id="outline-container-orgfdf8cbd" class="outline-2">
<h2 id="orgfdf8cbd"><span class="section-number-2">3</span> Deploy a WordPress as a Service (as a DevOps)</h2>
<div class="outline-text-2" id="text-3">
<p>
In the previous sessions, we saw how to boot a VM with OpenStack, and
execute a post-installation script using the <code>user-data</code> mechanism.
Such mechanism can help us to install software but it is not enough to
deploy a real Cloud application. Cloud applications are composed of
multiple services that collaborate to deliver the application. Each
service is in charge of one aspect of the application. This separation
of concerns brings flexibility. If a single service is overloaded, it
is common to deploy new units of this service to balance the load.
</p>

<p>
Let&rsquo;s take a simple example: <a href="https://wordpress.org/">WordPress</a>! WordPress is a very popular
content management system (CMS) in use on the Web. People use it to
create websites, blogs or applications. It is open-source, written in
PHP and composed of two elements: a Web server (Apache) and database
(MariaDB). Apache serves the PHP code of WordPress and stores its
information in the database.
</p>

<p>
Automation is a very important concept for DeVops. Imagine you have
your own datacenter and want to exploit it by renting WordPress
instances to your customers. Each time a client rents an instance, you
have to manually deploy it. Wouldn&rsquo;t it be more convenient to automate
all the operations? üòé
</p>

<div class="do">
<p>
As the DevOps of OPH &#x2013; Online Polytech Hosting &#x2013; your job is to automatize
the deployment of WordPress on your OpenStack. To do so, you have to
make a bash script that:
</p>

<ol class="org-ol">
<li>Starts <code>wordpress-db</code>: a VM that contains the MariaDB database for
WordPress.</li>
<li>Waits until its final deployment (the database is running)</li>
<li>Starts <code>wordpress-app</code>: a VM that contains a web server and serves
the Wordpress CMS.</li>
<li>Finally, connects to the WordPress website and initializes a new
WordPress project named <code>os-oph</code>.</li>
</ol>

<p>
The <code>rsc</code> directory provides bash scripts to deploy the MariaDB
database and web server of WordPress (also in <a href="#orgf02c602">Appendix</a>). Review it
before going any further (spot the <b>TODO</b>).
</p>

<p>
Also, remind to <a href="#sec:debian9-ftw">clean your environment</a>.
</p>

<div class="solution">
<p>
Find the solution in the <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/rsc/wordpress-deploy.sh"><code>rsc/wordpress-deploy.sh</code></a> script.
</p>

<p>
First thing first, enable HTTP connections.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack security group rule create $<span style="color: #DFAF8F;">SECGROUP_ID</span> <span style="color: #CC9393;">\</span>
  --proto tcp --remote-ip <span style="color: #BFEBBF;">0.0.0.0/0</span> <span style="color: #CC9393;">\</span>
  --dst-port <span style="color: #BFEBBF;">80</span>
</pre>
</div>

<p>
Then start a VM with the <code>wordpress-db</code> name, <code>debian-9</code> image,
<code>m1.mini</code> flavor, <code>test</code> network and <code>admin</code> key-pair. Also,
contextualize your VM with the <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/rsc/install-mariadb.sh"><code>rsc/install-mariadb.sh</code></a> script thanks
to the <code>--user-data ./rsc/install-mariadb.sh</code> option.
</p>

<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image debian-9 <span style="color: #CC9393;">\</span>
  --flavor m1.mini --network test <span style="color: #CC9393;">\</span>
  --key-name admin <span style="color: #CC9393;">\</span>
  --user-data ./rsc/install-mariadb.sh <span style="color: #CC9393;">\</span>
  wordpress-db

wait_contextualization wordpress-db
</pre>
</div>

<p>
Next, start a VM with <code>wordpress-app</code> name, <code>debian-9</code> image,
<code>m1.mini</code> flavor, <code>test</code> network and <code>admin</code> key-pair. Also,
contextualize your VM with the <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/rsc/install-wp.sh"><code>rsc/install-wp.sh</code></a> script thanks to
the <code>--user-data ./rsc/install-wp.sh</code> option. Note that you need to
provide the IP address of the <code>wordpress-db</code> to this script before
running it.
</p>

<p>
Set the script with IP address of <code>wordpress-db</code> # and floating ip
</p>
<div class="org-src-container">
<pre class="src src-bash">sed -i <span style="color: #CC9393;">'13s|.*|DB_HOST="'</span>$<span style="color: #DCDCCC;">(</span>openstack server show wordpress-db -c addresses -f value | sed -Er <span style="color: #CC9393;">"s/test=//g"</span><span style="color: #DCDCCC;">)</span><span style="color: #CC9393;">'"|'</span> ./rsc/install-wp.sh
</pre>
</div>

<p>
Then, create <code>wordpress-app</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image debian-9 <span style="color: #CC9393;">\</span>
  --flavor m1.mini --network test <span style="color: #CC9393;">\</span>
  --key-name admin <span style="color: #CC9393;">\</span>
  --user-data ./rsc/install-wp.sh <span style="color: #CC9393;">\</span>
  wordpress-app

wait_contextualization wordpress-app
</pre>
</div>

<p>
Get a floating ip for the VM.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #DFAF8F;">WP_APP_FIP</span>=$<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Attach the <code>WP_APP_FIP</code> floating ip to that VM.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip wordpress-app <span style="color: #CC9393;">"${WP_APP_FIP}"</span>
</pre>
</div>

<p>
Setup redirection to access your floating ip on port 80.
</p>
<pre class="example">
sudo iptables -t nat -A PREROUTING -p tcp --dport 8081 -j DNAT --to "${WP_APP_FIP}:80"
</pre>


<p>
Finally, you can reach WordPress on <a href="http://&lt;ip-of-your-lab&gt;:8080/wp">http://&lt;ip-of-your-lab&gt;:8080/wp</a>.
</p>

<div class="note">
<p>
Optionally, you can do it with an SSH tunnel to access <code>10.20.20.*</code>
from your own machine.
</p>
<pre class="example">
ssh -NL 8080:&lt;floating-ip&gt;:80 -l root &lt;ip-of-your-lab-machine&gt;
</pre>


<p>
Then, reach WordPress on <a href="http://localhost:8080/wp">http://localhost:8080/wp</a>.
</p>

</div>

</div>

</div>
</div>
</div>

<div id="outline-container-orgf8de88b" class="outline-2">
<h2 id="orgf8de88b"><span class="section-number-2">4</span> Automatize the deployment with Heat</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="https://docs.openstack.org/heat/train/">Heat</a> is the OpenStack orchestrator: it eats templates (called HOT for
Heat Orchestration Template - which are files written in YAML)
describing the OpenStack infrastructure you want to deploy (e.g. VMs,
networks, storages) as well as software configurations. Then the Heat
engine is in charge of sending the appropriate requests to OpenStack
to deploy the system described in your template (deployments are
called <code>stacks</code> in Heat). This section manipulates Heat to understand
how to deploy applications on OpenStack. Template snippets in the
following are available under the <code>rsc/heat-templates/</code> directory. You
may also find interesting examples in the <a href="https://docs.openstack.org/heat/train/template_guide/basic_resources.html">Heat documentation</a>, or on
the <a href="https://github.com/openstack/heat-templates">heat-templates repository</a>.
</p>
</div>

<div id="outline-container-org50e6fbe" class="outline-3">
<h3 id="org50e6fbe"><span class="section-number-3">4.1</span> Install the Heat orchestration service on microstack</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The documentation to install Heat on Ubuntu is available <a href="https://docs.openstack.org/heat/train/install/install-ubuntu.html">online</a>. The
script <a href="install-heat.sh">install-heat.sh</a> is based on that documentation and it
installs Heat on top of microstack. Execute it with <code>sudo</code> before
going any further.
</p>

<pre class="example">
sudo ./install-heat.sh
</pre>
</div>
</div>

<div id="outline-container-orgdbfa668" class="outline-3">
<h3 id="orgdbfa668"><span class="section-number-3">4.2</span> Boot a VM</h3>
<div class="outline-text-3" id="text-4-2">
<p>
The simplest HOT template you can declare describes how to boot a VM.
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">The following heat template version tag is mandatory:</span>
<span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Here we define a simple decription of the template (optional):</span>
<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Simply boot a VM!</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Here we declare the resources to deploy.</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Resources are defined by a name and a type which described many properties:</span>
<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Name of my resource:</span>
  <span style="color: #DFAF8F;">heat-vm</span>:
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Its type, here we want to define an OpenStack Nova server:</span>
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: hello_world      <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Name of the VM</span>
      <span style="color: #DFAF8F;">image</span>: debian-9        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Its image of the VM (must be available in Glance)</span>
      <span style="color: #DFAF8F;">flavor</span>: m1.mini        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Its flavor (must exist in Nova)</span>
      <span style="color: #DFAF8F;">key_name</span>: admin        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Name of the SSH Key (must exist in Nova)</span>
      <span style="color: #DFAF8F;">networks</span>:              <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">List of networks to connect to</span>
        - {<span style="color: #DFAF8F;">network</span>: test}
</pre>
</div>

<p>
As depicted in this example, the different OpenStack resources can be
declared using types. OpenStack resource types are listed in the
<a href="https://docs.openstack.org/heat/train/template_guide/openstack.html">documentation</a>, browsing this page, you can see that resources exist
for most OpenStack services (e.g. Nova, Neutron, Glance, Cinder,
Heat). Here, we declare a new resource called <code>heat-vm</code> which is
defined by the type <code>OS::Nova::Server</code> to declare a new virtual
machine. A type specifies different properties (some are mandatory,
some are optional, <a href="https://docs.openstack.org/heat/train/template_guide/openstack.html">see the documentation</a> for more details). The
<code>OS::Nova::Server</code> properties should be familiar to you since it is
the classical properties Nova requires to boot a VM (i.e. name, image,
flavor, key name). Once you have written this template in a file, you
can now deploy the stack as following:
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack stack create -t ./rsc/heat-templates/1_boot_vm.yaml hw1
openstack stack list
openstack stack show hw1
watch openstack server list
openstack stack delete --wait --yes hw1
</pre>
</div>

<p>
This simple template is enough to run a virtual machine. However, it
is very static. In the next subsection, we are going to manipulate
parameters to add flexibility.
</p>
</div>
</div>

<div id="outline-container-org073ae2c" class="outline-3">
<h3 id="sec:heat-params"><span class="section-number-3">4.3</span> Need more flexibility: let&rsquo;s add parameters</h3>
<div class="outline-text-3" id="text-sec:heat-params">
<p>
Templates can be more flexible with parameters. To that end you can:
</p>
<ul class="org-ul">
<li>Declare a set of parameters to provide to your template.</li>
<li>Use the <a href="https://docs.openstack.org/heat/train/template_guide/hot_spec.html#hot-spec-intrinsic-functions">intrinsic function</a> <code>get_param</code> to map those parameters in
your resource declarations.</li>
</ul>

<p>
The next template is an example with four parameters. The first one is
related to the VM name and must be provided during the stack creation.
The second one is the name of the VM image with a <code>debian-9</code> as
default value. The third argument corresponds to the flavor and
defaults to <code>m1.small</code>. Finally, the last one defines the SSH key to
use and defaults to <code>admin</code>.
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
    <span style="color: #CC9393;">Simply boot a VM with params!</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Here we define parameters</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters have a name, and a list of properties:</span>
<span style="color: #DFAF8F;">parameters</span>:
  <span style="color: #DFAF8F;">the_vm_name</span>:
    <span style="color: #DFAF8F;">type</span>: string                     <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">The type of the parameter (required)</span>
    <span style="color: #DFAF8F;">description</span>: Name of the server  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">An optional description</span>
  <span style="color: #DFAF8F;">the_image</span>:
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">description</span>: Image to use for servers
    <span style="color: #DFAF8F;">default</span>: debian-9                <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">An optional default value</span>
  <span style="color: #DFAF8F;">the_flavor</span>:
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">description</span>: Flavor to use for servers
    <span style="color: #DFAF8F;">default</span>: m1.small
  <span style="color: #DFAF8F;">the_key</span>:
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">description</span>: Key name to use for servers
    <span style="color: #DFAF8F;">default</span>: admin

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Here we use intrinsic functions to get the parameters:</span>
<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">heat-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>:     { <span style="color: #DFAF8F;">get_param</span>: the_vm_name }
      <span style="color: #DFAF8F;">image</span>:    { <span style="color: #DFAF8F;">get_param</span>: the_image }
      <span style="color: #DFAF8F;">flavor</span>:   { <span style="color: #DFAF8F;">get_param</span>: the_flavor }
      <span style="color: #DFAF8F;">key_name</span>: { <span style="color: #DFAF8F;">get_param</span>: the_key }
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
</pre>
</div>

<p>
To deploy this stack, run the next command. It deploys the VM by
overriding the default flavor value <code>m1.mini</code> with <code>m1.small</code>. This
can be checked in <code>openstack server list</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack stack create -t ./rsc/heat-templates/2_boot_vm_with_params.yaml <span style="color: #CC9393;">\</span>
  --parameter <span style="color: #DFAF8F;">the_vm_name</span>=hello_params <span style="color: #CC9393;">\</span>
  --parameter <span style="color: #DFAF8F;">the_flavor</span>=m1.small <span style="color: #CC9393;">\</span>
  hw2
openstack server list
openstack stack delete --wait --yes hw2
</pre>
</div>

<p>
The parameter <code>the_vm_name</code> is required as no default value is
provided. If you try to create a stack without providing this
parameter, you end with an error.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack stack create -t ./rsc/heat-templates/2_boot_vm_with_params.yaml <span style="color: #CC9393;">\</span>
    --parameter <span style="color: #DFAF8F;">the_flavor</span>=m1.medium <span style="color: #CC9393;">\</span>
    hw2_error

ERROR: The Parameter <span style="color: #DCDCCC;">(</span>the_vm_name<span style="color: #DCDCCC;">)</span> was not provided.
</pre>
</div>

<p>
Parameters are the inputs of templates. The next subsection, focuses
on declaring outputs, so that a stack can return a set of
attributes (e.g., the IP address of a deployed VM).
</p>
</div>
</div>

<div id="outline-container-org316f0a2" class="outline-3">
<h3 id="sec:heat-outputs"><span class="section-number-3">4.4</span> Need to return values: let&rsquo;s use outputs!</h3>
<div class="outline-text-3" id="text-sec:heat-outputs">
<p>
Templates can declare a set of attributes to return. For instance, you
might need to know the IP address of a resource at runtime. To that
end, you can declare attributes in a new section called <code>outputs</code>:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot a VM and return its IP address!</span>

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">heat-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: hello_outputs
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">We set here outputs (stack returned attributes).</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Outputs are defined by a name, and a set of properties:</span>
<span style="color: #DFAF8F;">outputs</span>:
  <span style="color: #DFAF8F;">HOSTIP</span>:
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">The description is optional</span>
    <span style="color: #DFAF8F;">description</span>: IP address of the created instance
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Use `get_attr` to find the value of `HOSTIP`. The `get_attr`</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">function references an attribute of a resouces, here the</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">`addresses.test[0].addr` of `heat-vm`.</span>
    <span style="color: #5F7F5F;">#</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">The following should be read:</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">- on `heat-vm` resource (which is an object ...)</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">- select the `addresses` attribute (which is an object ...)</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">- select the `test` attribute (which is a list ...)</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">- pick the element at indices `0` (which is an object ...)</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">- select the `addr` attribute (which is a string)</span>
    <span style="color: #DFAF8F;">value</span>: { <span style="color: #DFAF8F;">get_attr</span>: [heat-vm, addresses, test, 0, addr] }
  <span style="color: #DFAF8F;">HOSTNAME</span>:
    <span style="color: #DFAF8F;">description</span>: Hostname of the created instance
    <span style="color: #DFAF8F;">value</span>: { <span style="color: #DFAF8F;">get_attr</span>: [heat-vm, name] }
</pre>
</div>

<p>
The template declares an output attribute called <code>HOSTIP</code> which stores
the IP address of the VM resource. To find the IP address, it uses
another <a href="https://docs.openstack.org/heat/train/template_guide/hot_spec.html#get-attr">intrinsic function</a>: <code>get_attr</code>. Same with the <code>HOSTNAME</code>
output. Output attributes can be exploited in two ways: they can be
displayed from the CLI, or they can be fetched by other stack
templates (we will see this last case latter):
</p>

<div class="org-src-container">
<pre class="src src-bash">openstack stack create -t ./rsc/heat-templates/3_boot_vm_with_output.yaml hw3
openstack stack output list hw3
openstack stack output show hw3 HOSTIP
openstack stack delete --wait --yes hw3
</pre>
</div>

<div class="note">
<p>
Once again, the Heat documentation is your friend to find out
<a href="https://docs.openstack.org/heat/train/template_guide/openstack.html#OS::Nova::Server-attrs">attributes</a>. As such, you can reference the IP address with the
<code>network</code> attribute.
</p>
<pre class="example">
get_attr: [heat-vm, networks, test, 0]
</pre>


<p>
The source code of Heat also list <a href="https://github.com/openstack/heat/blob/0703ca7bb19ca3bb06009c828a66bababf9970b8/heat/engine/resources/openstack/nova/server.py#L646-L736">extra attributes</a> that lets you find
the IP address such as <code>first_address</code>, but that one is deprecated
though.
</p>
<pre class="example">
get_attr: [heat-vm, networks, test, 0]
get_attr: [heat-vm, first_address]
</pre>


<p>
Finally, you can introspect all attributes of a resource with the
following command at runtime:
</p>
<pre class="example">
python -c "import pprint; pprint.pprint($(openstack stack resource show hw3 heat-vm -c attributes -f value))"
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #DCDCCC;">{</span>u<span style="color: #CC9393;">'OS-DCF:diskConfig'</span>: u<span style="color: #CC9393;">'MANUAL'</span>,
 <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">...</span>
 u<span style="color: #CC9393;">'addresses'</span>: <span style="color: #BFEBBF;">{</span>u<span style="color: #CC9393;">'test'</span>: <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">{</span>u<span style="color: #CC9393;">'OS-EXT-IPS-MAC:mac_addr'</span>: u<span style="color: #CC9393;">'fa:16:3e:73:10:fe'</span>,
                           u<span style="color: #CC9393;">'OS-EXT-IPS:type'</span>: u<span style="color: #CC9393;">'fixed'</span>,
                           u<span style="color: #CC9393;">'addr'</span>: u<span style="color: #CC9393;">'192.168.222.84'</span>,
                           u<span style="color: #CC9393;">'version'</span>: <span style="color: #BFEBBF;">4</span><span style="color: #93E0E3;">}</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">}</span>,
 <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">...</span>
 u<span style="color: #CC9393;">'image'</span>: <span style="color: #BFEBBF;">{</span>u<span style="color: #CC9393;">'id'</span>: u<span style="color: #CC9393;">'3c91bbf5-5d1f-4e72-bf77-6dbc19c8351c'</span>,
            u<span style="color: #CC9393;">'links'</span>: <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">{</span>u<span style="color: #CC9393;">'href'</span>: u<span style="color: #CC9393;">'http://10.20.20.1:8774/images/3c91bbf5-5d1f-4e72-bf77-6dbc19c8351c'</span>,
                        u<span style="color: #CC9393;">'rel'</span>: u<span style="color: #CC9393;">'bookmark'</span><span style="color: #93E0E3;">}</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">}</span>,
 <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">...</span>
 u<span style="color: #CC9393;">'name'</span>: u<span style="color: #CC9393;">'hello_outputs'</span><span style="color: #DCDCCC;">}</span>
</pre>
</div>

</div>
</div>
</div>

<div id="outline-container-org0dec031" class="outline-3">
<h3 id="org0dec031"><span class="section-number-3">4.5</span> Integrate <code>cloud-init</code></h3>
<div class="outline-text-3" id="text-4-5">
<p>
It is possible to declare a post-installation script in the template
with the <code>user_data</code> property.
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot a VM with a post-installation script!</span>

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">heat-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: hello_cloud_init
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
      <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">We set here the user-data:</span>
      <span style="color: #DFAF8F;">user_data</span>: |
        <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/env bash</span>

        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
        echo <span style="color: #CC9393;">""</span> &gt; /etc/resolv.conf
        echo <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install stuff and configure the MOTD</span>
<span style="color: #CC9393;">        apt-get update</span>
<span style="color: #CC9393;">        apt-get install -y fortune fortunes cowsay lolcat</span>
        echo <span style="color: #CC9393;">"#!/usr/bin/env bash"</span> &gt; /etc/profile.d/cowsay.sh
        echo <span style="color: #CC9393;">"fortune | cowsay -n | lolcat"</span> &gt;&gt; /etc/profile.d/cowsay.sh
</pre>
</div>

<pre class="example">
openstack stack create -t ./rsc/heat-templates/4_boot_vm_with_user-data.yaml hw4
</pre>


<p>
Associating a floating IP is a bit tricky with Heat, so let&rsquo;s do it
manually for now. Then, wait for <code>cloud-init</code> to finish and finally,
SSH on the VM (the <code>wait_contextualization</code> function comes from
section <a href="#sec:cloud-init">2.4.2</a>).
</p>

<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip hello_cloud_init <span style="color: #CC9393;">\</span>
  $<span style="color: #DCDCCC;">(</span>openstack floating ip create -c floating_ip_address -f value external<span style="color: #DCDCCC;">)</span>
wait_contextualization hello_cloud_init
openstack server ssh --login debian --identity ./admin.pem hello_cloud_init
openstack stack delete --wait --yes hw4
</pre>
</div>

<div class="note">
<p>
Find the <code>user_data</code> file executed on the VM by cloud-init at
<code>/var/lib/heat-cfntools/cfn-userdata</code>. This path comes from the log of
the VM boot (using <code>openstack console log show hello_cloud_init</code>)
right after the log <code>Cloud-init v. ... running</code>.
</p>

</div>
</div>
</div>

<div id="outline-container-org9c48010" class="outline-3">
<h3 id="org9c48010"><span class="section-number-3">4.6</span> Dynamic configuration with <code>cloud-init</code> and parameters</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Let&rsquo;s mix parameters and cloud-init to write a template with a
flexible post-installation script. With Heat, it is possible to
provide a parameter to your user-data at run-time by using a new
<a href="https://docs.openstack.org/heat/train/template_guide/hot_spec.html#str-replace">intrinsic function</a>: <code>str_replace</code>.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot a VM by installing a set of packages given as parameters!</span>

<span style="color: #DFAF8F;">parameters</span>:
  <span style="color: #DFAF8F;">package-names</span>:
    <span style="color: #DFAF8F;">label</span>: List of packages to install
    <span style="color: #DFAF8F;">type</span>: string

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">heat-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: hello_cloud_init_params
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
      <span style="color: #DFAF8F;">user_data</span>:
        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">This intrinsic function can replace strings in a template</span>
        <span style="color: #DFAF8F;">str_replace</span>:
          <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">We define here the script</span>
          <span style="color: #DFAF8F;">template</span>: |
              <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/env bash</span>
<span style="color: #CC9393;">              apt-get update</span>
<span style="color: #CC9393;">              apt-get install -y ${PKG-NAMES}</span>
          <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">We define here the parameters for our script</span>
          <span style="color: #DFAF8F;">params</span>:
            <span style="color: #DFAF8F;">${PKG-NAMES}</span>: { <span style="color: #DFAF8F;">get_param</span>: package-names }
</pre>
</div>

<p>
The template uses <code>str_replace</code> to instantiate variables in the
template. In this example, the parameter should be a string containing
a set of packages to install in the VM. You can deploy the stack as
follow:
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack stack create <span style="color: #CC9393;">\</span>
    -t ./rsc/heat-templates/5_boot_vm_with_user-data2.yaml <span style="color: #CC9393;">\</span>
    --parameter package-names=<span style="color: #CC9393;">"vim cowsay fortune fortunes lolcat"</span> <span style="color: #CC9393;">\</span>
   hw5
openstack stack delete --wait --yes hw5
</pre>
</div>

<p>
This mechanism is crucial to dynamically configure our services during
the deployment. For instance, <code>service-A</code> might require an IP address
in its configuration file to access <code>service-B</code>, which runs on another
VM. This IP address is only known at run-time, so it must be
represented by a variable managed in Heat templates. In the next
subsections, we are going to study how to declare such variable, so
that Heat resources can exchange information.
</p>
</div>
</div>

<div id="outline-container-orgcae96ef" class="outline-3">
<h3 id="sec:data-deps-rscs"><span class="section-number-3">4.7</span> Data dependency between resources</h3>
<div class="outline-text-3" id="text-sec:data-deps-rscs">
<p>
Let&rsquo;s declare a template with two VMs: <code>user</code> and <code>provider</code>. The idea
is to configure <code>user</code>&rsquo;s static lookup table for hostnames (more
information can be found by typing: <code>man hosts</code>), so that user can
target <code>provider</code> from its hostname rather than its IP address. To
that end, the template uses the <code>user_data</code> property together with the
<code>get_attr</code> function to edit the <code>/etc/hosts</code> file on <code>user</code>, and map
the IP address of <code>provider</code> with its hostname.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot two VMs and ease the access from user to provider!</span>

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">user-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: user
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
      <span style="color: #DFAF8F;">user_data</span>:
        <span style="color: #DFAF8F;">str_replace</span>:
          <span style="color: #DFAF8F;">template</span>: |
            <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/env bash</span>
            <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">With the following line, provider is reachable from its hostname</span>
            echo <span style="color: #CC9393;">"${IP_ADDRESS} provider"</span> &gt;&gt; /etc/hosts
          <span style="color: #DFAF8F;">params</span>:
            <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">`get_attr` references the following `provider-vm` resource.</span>
            <span style="color: #DFAF8F;">${IP_ADDRESS}</span>: { <span style="color: #DFAF8F;">get_attr</span>: [provider-vm, addresses, test, 0, addr] }

  <span style="color: #DFAF8F;">provider-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: provider
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
</pre>
</div>

<p>
In this example, <code>user</code> requires the IP address of <code>provider</code> to boot.
The Heat engine is in charge of managing dependencies between
resources. Take a look during the deployment, and check that
<code>provider</code> is deployed prior to <code>user</code>.
</p>

<pre class="example">
openstack stack create -t ./rsc/heat-templates/6_boot_vms_with_exchange.yaml hw6 \
  &amp;&amp; watch openstack server list
openstack server add floating ip user \
  $(openstack floating ip create -c floating_ip_address -f value external)
openstack server ssh --login debian --identity ./admin.pem --address-type public user
debian@user:~$ ping provider -c 2
PING provider-vm (192.168.222.238) 56(84) bytes of data.
64 bytes from provider (192.168.222.238): icmp_seq=1 ttl=64 time=1.27 ms
64 bytes from provider (192.168.222.238): icmp_seq=2 ttl=64 time=3.07 ms

debian@user:~$ exit
openstack stack delete --wait --yes hw6
</pre>
</div>
</div>

<div id="outline-container-orgdf814ad" class="outline-3">
<h3 id="orgdf814ad"><span class="section-number-3">4.8</span> Nested templates</h3>
<div class="outline-text-3" id="text-4-8">
<p>
Heat is able to compose templates to keep human-readable files, using
nested templates. For instance, we can use a first template that
describes a virtual machine, and a second template which deploys
multiple VMs by referencing the first one. Rather than create the
first template, we can re-use the one from section <a href="#sec:heat-params">4.3</a>.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot two different VMs by exploiting nested templates!</span>

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">provider-vm</span>:
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Template can be provided as resource type (relatively to</span>
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">that template)</span>
    <span style="color: #DFAF8F;">type</span>: ./2_boot_vm_with_params.yaml
    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">The related properties are given as template's parameters:</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">the_vm_name</span>: provider
      <span style="color: #DFAF8F;">the_flavor</span>: m1.mini

  <span style="color: #DFAF8F;">user-vm</span>:
    <span style="color: #DFAF8F;">type</span>: ./2_boot_vm_with_params.yaml
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">the_vm_name</span>: user
</pre>
</div>

<p>
To compose template, a new resource can be defined by specifying its
type as the target of the desired template. A set of properties can be
provided to the nested template and will be interpreted as parameters.
</p>

<div class="org-src-container">
<pre class="src src-bash">openstack stack create -t ./rsc/heat-templates/7_nested_template.yaml hw7 <span style="color: #CC9393;">\</span>
  &amp;&amp; watch openstack server list
openstack stack delete --wait --yes hw7
</pre>
</div>

<p>
Nested templates are very convenient to keep your code clean and
re-use templates. Next section extends nested templates with data
dependency.
</p>
</div>
</div>

<div id="outline-container-orgcf47a5f" class="outline-3">
<h3 id="orgcf47a5f"><span class="section-number-3">4.9</span> Nested templates with data dependency</h3>
<div class="outline-text-3" id="text-4-9">
<p>
Let&rsquo;s describe the same deployment as in section <a href="#sec:data-deps-rscs">4.7</a>
by using nested templates. For that we need a new template:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot a VM, ease access to a remote host and return its IP address!</span>

<span style="color: #DFAF8F;">parameters</span>:
  <span style="color: #DFAF8F;">the_vm_name</span>:
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">description</span>: Name of the server
  <span style="color: #DFAF8F;">the_remote_hostname</span>:
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">description</span>: Host name of the remote host
    <span style="color: #DFAF8F;">default</span>: provider
  <span style="color: #DFAF8F;">the_remote_ip</span>:
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">description</span>: IP address of the remote host

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">hostname-vm</span>:
    <span style="color: #DFAF8F;">type</span>: <span style="color: #CC9393;">"OS::Nova::Server"</span>
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>:     { <span style="color: #DFAF8F;">get_param</span>: the_vm_name }
      <span style="color: #DFAF8F;">image</span>:    debian-9
      <span style="color: #DFAF8F;">flavor</span>:   m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
      <span style="color: #DFAF8F;">user_data</span>:
        <span style="color: #DFAF8F;">str_replace</span>:
          <span style="color: #DFAF8F;">params</span>:
            <span style="color: #DFAF8F;">${HOSTNAME}</span>: { <span style="color: #DFAF8F;">get_param</span>: the_remote_hostname }
            <span style="color: #DFAF8F;">${IP_ADDRESS}</span>: { <span style="color: #DFAF8F;">get_param</span>: the_remote_ip }
          <span style="color: #DFAF8F;">template</span>: |
            <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/env bash</span>
            <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">With the following line, the remote host is reachable from its hostname</span>
            echo <span style="color: #CC9393;">"${IP_ADDRESS} ${HOSTNAME}"</span> &gt;&gt; /etc/hosts

<span style="color: #DFAF8F;">outputs</span>:
  <span style="color: #DFAF8F;">HOSTIP</span>:
    <span style="color: #DFAF8F;">description</span>: IP address of the created instance
    <span style="color: #DFAF8F;">value</span>: { <span style="color: #DFAF8F;">get_attr</span>: [hostname-vm, networks, test, 0] }
</pre>
</div>

<p>
We can now declare the main template. While it defines three VMs, this
template is easy to read since it points to the template created
previously and template in section <a href="#sec:heat-outputs">4.4</a>.
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot three VMs and ease the access to provider using nested</span>
<span style="color: #CC9393;">  templates!</span>

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">provider-vm</span>:
    <span style="color: #DFAF8F;">type</span>: ./3_boot_vm_with_output.yaml

  <span style="color: #DFAF8F;">user-vm1</span>:
    <span style="color: #DFAF8F;">type</span>: ./8_nested_template_boot_vm.yaml
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">the_vm_name</span>: user1
      <span style="color: #DFAF8F;">the_remote_ip</span>: { <span style="color: #DFAF8F;">get_attr</span>: [provider-vm, HOSTIP] }
      <span style="color: #DFAF8F;">the_remote_hostname</span>: { <span style="color: #DFAF8F;">get_attr</span>: [provider-vm, HOSTNAME] }

  <span style="color: #DFAF8F;">user-vm2</span>:
    <span style="color: #DFAF8F;">type</span>: ./8_nested_template_boot_vm.yaml
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">the_vm_name</span>: user2
      <span style="color: #DFAF8F;">the_remote_ip</span>: { <span style="color: #DFAF8F;">get_attr</span>: [provider-vm, HOSTIP] }
      <span style="color: #DFAF8F;">the_remote_hostname</span>: { <span style="color: #DFAF8F;">get_attr</span>: [provider-vm, HOSTNAME] }
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d33642" class="outline-3">
<h3 id="org7d33642"><span class="section-number-3">4.10</span> Other type of resources: floating IP</h3>
<div class="outline-text-3" id="text-4-10">
<p>
It&rsquo;s Floating IP time!
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Here we define a simple decription of the template (optional):</span>
<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Boot a VM and associate a floating IP.</span>

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">server</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Nova::Server
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">name</span>: hello_fip
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">key_name</span>: admin
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}

  <span style="color: #DFAF8F;">floating-ip</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Neutron::FloatingIP
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">floating_network</span>: external

  <span style="color: #DFAF8F;">association</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Neutron::FloatingIPAssociation
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">floatingip_id</span>: { <span style="color: #DFAF8F;">get_resource</span>: floating-ip }
      <span style="color: #DFAF8F;">port_id</span>: { <span style="color: #DFAF8F;">get_attr</span>: [server, addresses, test, 0, port]}
</pre>
</div>

<pre class="example">
openstack stack create -t ./rsc/heat-templates/9_floating_ip.yaml --wait hw9
</pre>


<p>
You may find the floating IP by listing servers.
</p>
<pre class="example">
openstack server list
</pre>

<p>
Or by asking Heat about attributes of the <code>floating-ip</code> resource.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #DFAF8F;">FIP_RSC_ATTRIBUTES</span>=$<span style="color: #DCDCCC;">(</span>openstack stack resource show -c attributes -f value hw123 floating-ip<span style="color: #DCDCCC;">)</span>
python -c <span style="color: #CC9393;">"print('floating ip is %s' % ${FIP_RSC_ATTRIBUTES}['floating_ip_address'])"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc814de4" class="outline-2">
<h2 id="orgc814de4"><span class="section-number-2">5</span> Deploy a WordPress as a Service (as a Heat DevOps)</h2>
<div class="outline-text-2" id="text-5">
<p>
As a DevOps at OPH &#x2013; Online Polytech Hosting &#x2013; you are now in charge of the
automation process of deploying WordPress instances for clients.
Congratulation! To that end, you have to use what you learned from the
previous section to design a template that describes a WordPress
application using Heat. We are going to deploy WordPress inside two
VMs: the first one holds the web server, the second one runs the
database:
</p>

<ul class="org-ul">
<li>VM1: Apache + PHP + WordPress code</li>
<li>VM2: MariaDB</li>
</ul>

<div class="do">
<p>
Create three HOT files:
</p>

<dl class="org-dl">
<dt><code>db-vm.yml</code> </dt><dd>Contains the description of the VM running MariaDB.</dd>
<dt><code>wp-vm.yml</code> </dt><dd>Contains the description of the VM running the Web
server and serving Wordpress ;</dd>
<dt><code>wp-app.yml</code></dt><dd>Contains the description of the WordPress
application (glues the <code>db-vm.yml</code> and <code>web-vm.yml</code>
together).</dd>
</dl>

<p>
Once it is deployed, you should be able to reach the wordpress service by
going on <a href="http://&lt;web-server-fip-address&gt;/wp">http://&lt;web-server-fip-address&gt;/wp</a>.
</p>

<div class="solution">
<p>
Find the solution in the <a href="https://raw.githubusercontent.com/BeyondTheClouds/lectures/master/2019/os-polytech-nantes/rsc/heat-templates/wordpress/"><code>rsc/heat-templates/wordpress/</code></a> directory.
</p>

</div>

</div>
</div>

<div id="outline-container-org2328605" class="outline-3">
<h3 id="org2328605"><span class="section-number-3">5.1</span> Database VM template&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Deploy an MariaDB server, outputs its IP address.</span>

<span style="color: #DFAF8F;">parameters</span>:
  <span style="color: #DFAF8F;">ServerKeyName</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the SSH key to provide to cloud-init
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: admin

  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters used in the cloud-init script to install &amp; configure</span>
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">MariaDB.</span>
  <span style="color: #DFAF8F;">DBRootPassword</span>:
    <span style="color: #DFAF8F;">label</span>: Value of the password to manage the database
    <span style="color: #DFAF8F;">type</span>: string
  <span style="color: #DFAF8F;">DBName</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the database to create
    <span style="color: #DFAF8F;">type</span>: string
  <span style="color: #DFAF8F;">DBUser</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the database user
    <span style="color: #DFAF8F;">type</span>: string
  <span style="color: #DFAF8F;">DBPassword</span>:
    <span style="color: #DFAF8F;">label</span>: Password to access the database
    <span style="color: #DFAF8F;">type</span>: string

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">db-vm</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Nova::Server
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">key_name</span>: { <span style="color: #DFAF8F;">get_param</span>: ServerKeyName }
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
      <span style="color: #DFAF8F;">user_data</span>:
        <span style="color: #DFAF8F;">str_replace</span>:
          <span style="color: #DFAF8F;">template</span>: { <span style="color: #DFAF8F;">get_file</span>: ../../install-mariadb.sh }
          <span style="color: #DFAF8F;">params</span>:
            <span style="color: #DFAF8F;">${DB_ROOTPASSWORD}</span>: { <span style="color: #DFAF8F;">get_param</span>: DBRootPassword }
            <span style="color: #DFAF8F;">${DB_NAME}</span>: { <span style="color: #DFAF8F;">get_param</span>: DBName }
            <span style="color: #DFAF8F;">${DB_USER}</span>: { <span style="color: #DFAF8F;">get_param</span>: DBUser }
            <span style="color: #DFAF8F;">${DB_PASSWORD}</span>: { <span style="color: #DFAF8F;">get_param</span>: DBPassword }
<span style="color: #DFAF8F;">outputs</span>:
  <span style="color: #DFAF8F;">DBHost</span>:
    <span style="color: #DFAF8F;">description</span>: IP address of the created instance running MariaDB
    <span style="color: #DFAF8F;">value</span>: { <span style="color: #DFAF8F;">get_attr</span>: [db-vm, networks, test, 0] }
</pre>
</div>
</div>
</div>

<div id="outline-container-org28a16ea" class="outline-3">
<h3 id="org28a16ea"><span class="section-number-3">5.2</span> Web VM template&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Deploy an HTTP server that serves WordPress. Requires an SQL</span>
<span style="color: #CC9393;">  database, whose IP address must be provided as a parameter.</span>

<span style="color: #DFAF8F;">parameters</span>:
  <span style="color: #DFAF8F;">ServerKeyName</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the SSH key to provide to cloud-init
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: admin

  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters used in the cloud-init script to install &amp; configure</span>
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">the WordPress app.</span>
  <span style="color: #DFAF8F;">DBName</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the database to use
    <span style="color: #DFAF8F;">type</span>: string
  <span style="color: #DFAF8F;">DBUser</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the database user
    <span style="color: #DFAF8F;">type</span>: string
  <span style="color: #DFAF8F;">DBPassword</span>:
    <span style="color: #DFAF8F;">label</span>: Password to access the database
    <span style="color: #DFAF8F;">type</span>: string
  <span style="color: #DFAF8F;">DBHost</span>:
    <span style="color: #DFAF8F;">label</span>: IP address of the SQL server
    <span style="color: #DFAF8F;">type</span>: string

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">wp-vm</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Nova::Server
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">key_name</span>: { <span style="color: #DFAF8F;">get_param</span>: ServerKeyName }
      <span style="color: #DFAF8F;">image</span>: debian-9
      <span style="color: #DFAF8F;">flavor</span>: m1.mini
      <span style="color: #DFAF8F;">networks</span>:
        - {<span style="color: #DFAF8F;">network</span>: test}
      <span style="color: #DFAF8F;">user_data</span>:
        <span style="color: #DFAF8F;">str_replace</span>:
          <span style="color: #DFAF8F;">template</span>: { <span style="color: #DFAF8F;">get_file</span>: ../../install-wp.sh }
          <span style="color: #DFAF8F;">params</span>:
            <span style="color: #DFAF8F;">${DB_NAME}</span>:     { <span style="color: #DFAF8F;">get_param</span>: DBName }
            <span style="color: #DFAF8F;">${DB_USER}</span>:     { <span style="color: #DFAF8F;">get_param</span>: DBUser }
            <span style="color: #DFAF8F;">${DB_PASSWORD}</span>: { <span style="color: #DFAF8F;">get_param</span>: DBPassword }
            <span style="color: #DFAF8F;">${DB_HOST}</span>:     { <span style="color: #DFAF8F;">get_param</span>: DBHost }

  <span style="color: #DFAF8F;">floating-ip</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Neutron::FloatingIP
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">floating_network</span>: external

  <span style="color: #DFAF8F;">association</span>:
    <span style="color: #DFAF8F;">type</span>: OS::Neutron::FloatingIPAssociation
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">floatingip_id</span>: { <span style="color: #DFAF8F;">get_resource</span>: floating-ip }
      <span style="color: #DFAF8F;">port_id</span>: { <span style="color: #DFAF8F;">get_attr</span>: [wp-vm, addresses, test, 0, port]}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf642e7" class="outline-3">
<h3 id="orgbf642e7"><span class="section-number-3">5.3</span> Wordpress application template&#xa0;&#xa0;&#xa0;<span class="tag"><span class="solution">solution</span></span></h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #DFAF8F;">heat_template_version</span>: 2017-09-01

<span style="color: #DFAF8F;">description</span>: &gt;
  <span style="color: #CC9393;">Deploy a WordPress application, composed of an SQL</span>
<span style="color: #CC9393;">  instance and an HTTP instance that serves WordPress.</span>


<span style="color: #DFAF8F;">parameters</span>:
  <span style="color: #DFAF8F;">ServerKeyName</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the SSH key to provide to cloud-init
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: admin

  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters used in the cloud-init script to install &amp; configure</span>
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">MariaDB</span>
  <span style="color: #DFAF8F;">DBRootPassword</span>:
    <span style="color: #DFAF8F;">label</span>: Value of the password to manage the database
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: 0p3nSt4cK
  <span style="color: #DFAF8F;">DBName</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the database to create
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: wordpress
  <span style="color: #DFAF8F;">DBUser</span>:
    <span style="color: #DFAF8F;">label</span>: Name of the database user
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: donatello
  <span style="color: #DFAF8F;">DBPassword</span>:
    <span style="color: #DFAF8F;">label</span>: Password to access the database
    <span style="color: #DFAF8F;">type</span>: string
    <span style="color: #DFAF8F;">default</span>: leonardo

<span style="color: #DFAF8F;">resources</span>:
  <span style="color: #DFAF8F;">database</span>:
    <span style="color: #DFAF8F;">type</span>: ./db-vm.yaml
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">ServerKeyName</span>: { <span style="color: #DFAF8F;">get_param</span>: ServerKeyName }
      <span style="color: #DFAF8F;">DBRootPassword</span>: { <span style="color: #DFAF8F;">get_param</span>: DBRootPassword }
      <span style="color: #DFAF8F;">DBName</span>: { <span style="color: #DFAF8F;">get_param</span>: DBName }
      <span style="color: #DFAF8F;">DBUser</span>: { <span style="color: #DFAF8F;">get_param</span>: DBUser }
      <span style="color: #DFAF8F;">DBPassword</span>: { <span style="color: #DFAF8F;">get_param</span>: DBPassword }
  <span style="color: #DFAF8F;">wordpress</span>:
    <span style="color: #DFAF8F;">type</span>: ./wp-vm.yaml
    <span style="color: #DFAF8F;">properties</span>:
      <span style="color: #DFAF8F;">ServerKeyName</span>: { <span style="color: #DFAF8F;">get_param</span>: ServerKeyName }
      <span style="color: #DFAF8F;">DBName</span>: { <span style="color: #DFAF8F;">get_param</span>: DBName }
      <span style="color: #DFAF8F;">DBUser</span>: { <span style="color: #DFAF8F;">get_param</span>: DBUser }
      <span style="color: #DFAF8F;">DBPassword</span>: { <span style="color: #DFAF8F;">get_param</span>: DBPassword }
      <span style="color: #DFAF8F;">DBHost</span>: { <span style="color: #DFAF8F;">get_attr</span>: [database, DBHost] }
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf02c602" class="outline-2">
<h2 id="orgf02c602"><span class="section-number-2">6</span> Appendix</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orge817e56" class="outline-3">
<h3 id="orge817e56"><span class="section-number-3">6.1</span> Install MariaDB on Debian 9</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/</span><span style="color: #F0DFAF; font-weight: bold;">env</span><span style="color: #7F9F7F;"> bash</span>
<span style="color: #5F7F5F;">#</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install and configure MariaDB for Debian 9.</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">""</span> &gt; /etc/resolv.conf
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters</span>
<span style="color: #DFAF8F;">DB_ROOTPASSWORD</span>=root
<span style="color: #DFAF8F;">DB_NAME</span>=wordpress    <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Wordpress DB name</span>
<span style="color: #DFAF8F;">DB_USER</span>=silr         <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Wordpress DB user</span>
<span style="color: #DFAF8F;">DB_PASSWORD</span>=silr     <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Wordpress DB pass</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install MariaDB</span>
apt update -q
apt install -q -y mariadb-server mariadb-client

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Next line stops mysql install from popping up request for root password</span>
<span style="color: #DCDCCC; font-weight: bold;">export</span> <span style="color: #DFAF8F;">DEBIAN_FRONTEND</span>=noninteractive
sed -i <span style="color: #CC9393;">'s/127.0.0.1/0.0.0.0/'</span> /etc/mysql/mariadb.conf.d/50-server.cnf
systemctl restart mysql

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Setup MySQL root password and create a user and add remote privs to app subnet</span>
mysqladmin -u root password $<span style="color: #DCDCCC;">{</span><span style="color: #DFAF8F;">DB_ROOTPASSWORD</span><span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Create the wordpress database</span>
cat &lt;&lt; EOSQL | mysql -u root --password=$<span style="color: #DCDCCC;">{</span><span style="color: #DFAF8F;">DB_ROOTPASSWORD</span><span style="color: #DCDCCC;">}</span>
<span style="color: #F0DFAF; font-weight: bold;">FLUSH PRIVILEGES;</span>
<span style="color: #F0DFAF; font-weight: bold;">CREATE USER '${DB_USER}'@'localhost';</span>
<span style="color: #F0DFAF; font-weight: bold;">CREATE DATABASE ${DB_NAME};</span>
<span style="color: #F0DFAF; font-weight: bold;">SET PASSWORD FOR '${DB_USER}'@'localhost'=PASSWORD("${DB_PASSWORD}");</span>
<span style="color: #F0DFAF; font-weight: bold;">GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';</span>
<span style="color: #F0DFAF; font-weight: bold;">CREATE USER '${DB_USER}'@'%';</span>
<span style="color: #F0DFAF; font-weight: bold;">SET PASSWORD FOR '${DB_USER}'@'%'=PASSWORD("${DB_PASSWORD}");</span>
<span style="color: #F0DFAF; font-weight: bold;">GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';</span>
<span style="color: #F0DFAF; font-weight: bold;">EOSQL</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a38bba" class="outline-3">
<h3 id="org0a38bba"><span class="section-number-3">6.2</span> Install Wordpress application on Debian 9</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">!/usr/bin/</span><span style="color: #F0DFAF; font-weight: bold;">env</span><span style="color: #7F9F7F;"> bash</span>
<span style="color: #5F7F5F;">#</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Install and configure Apache to serve Wordpress for Debian 9.</span>

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Fix DNS resolution</span>
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">""</span> &gt; /etc/resolv.conf
<span style="color: #DCDCCC; font-weight: bold;">echo</span> <span style="color: #CC9393;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Parameters</span>
<span style="color: #DFAF8F;">DB_NAME</span>=wordpress
<span style="color: #DFAF8F;">DB_USER</span>=silr
<span style="color: #DFAF8F;">DB_PASSWORD</span>=silr
<span style="color: #DFAF8F;">DB_HOST</span>=&lt;<span style="color: #D0BF8F; font-weight: bold;">TODO</span>&gt;

apt-get update -y
apt-get upgrade -y
apt-get install -q -y --force-yes wordpress apache2 curl

cat &lt;&lt; EOF &gt; /etc/apache2/sites-available/wp.conf
<span style="color: #F0DFAF; font-weight: bold;">Alias /wp/wp-content /var/lib/wordpress/wp-content</span>
<span style="color: #F0DFAF; font-weight: bold;">Alias /wp /usr/share/wordpress</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;Directory /usr/share/wordpress&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">    Options FollowSymLinks</span>
<span style="color: #F0DFAF; font-weight: bold;">    AllowOverride Limit Options FileInfo</span>
<span style="color: #F0DFAF; font-weight: bold;">    DirectoryIndex index.php</span>
<span style="color: #F0DFAF; font-weight: bold;">    Require all granted</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;/Directory&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;Directory /var/lib/wordpress/wp-content&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">    Options FollowSymLinks</span>
<span style="color: #F0DFAF; font-weight: bold;">    Require all granted</span>
<span style="color: #F0DFAF; font-weight: bold;">&lt;/Directory&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">EOF</span>

a2ensite wp
service apache2 reload

cat &lt;&lt; EOF &gt; /etc/wordpress/config-default.php
<span style="color: #F0DFAF; font-weight: bold;">&lt;?php</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_NAME', '${DB_NAME}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_USER', '${DB_USER}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_PASSWORD', '${DB_PASSWORD}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('DB_HOST', '${DB_HOST}');</span>
<span style="color: #F0DFAF; font-weight: bold;">define('WP_CONTENT_DIR', '/var/lib/wordpress/wp-content');</span>
<span style="color: #F0DFAF; font-weight: bold;">?&gt;</span>
<span style="color: #F0DFAF; font-weight: bold;">EOF</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ronan-Alexandre Cherrueau, Adrien Lebre, Didier Iscovery</p>
<p class="email">Email: <a href="mailto:{firstname.lastname}@inria.fr">{firstname.lastname}@inria.fr</a></p>
<p class="github">Find a typo, wanna make a proposition:
 <a href="https://github.com/BeyondTheClouds/lectures/issues/new?title=[os-polytech-19]">open an issue</a></p>
<p class="date">Last modification: 2019-12-09 Mon 15:41</p>
<p class="license">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.2.6) ‚Äì <a href="http://gongzhitaao.org/orgcss">Zhitao Gong</a> customized theme</p>
</div>
</body>
</html>
